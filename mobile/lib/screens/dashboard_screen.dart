import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../components/admin_layout.dart';
import '../services/providers.dart';
import '../services/sync_service.dart';
import '../services/local_db.dart';
import '../utils/theme.dart';

class DashboardScreen extends ConsumerWidget {
  const DashboardScreen({super.key});
  
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Header with sync button - matching PHP admin
          Row(
            children: [
              const Text(
                'لوحة التحكم - نظام إدارة الفندق',
                style: TextStyle(
                  fontSize: 24,
                  fontWeight: FontWeight.bold,
                  color: AppColors.textPrimary,
                ),
              ),
              const Spacer(),
              ElevatedButton.icon(
                onPressed: () async {
                  await ref.read(syncServiceProvider).runSync();
                },
                icon: const Icon(Icons.sync, size: 16),
                label: const Text('مزامنة'),
                style: ElevatedButton.styleFrom(
                  backgroundColor: AppColors.primaryColor,
                ),
              ),
            ],
          ),
          
          const SizedBox(height: 24),
          
          // Statistics Cards Row - exactly matching PHP dashboard
          Consumer(
            builder: (context, ref, _) {
              final roomsAsync = ref.watch(roomsListProvider);
              final cashAsync = ref.watch(cashTransactionsListProvider);
              final bookingsAsync = ref.watch(bookingsListProvider);
              final expensesAsync = ref.watch(expensesListProvider);
              
              return roomsAsync.when(
                loading: () => const Center(child: CircularProgressIndicator()),
                error: (e, st) => Center(child: Text('خطأ: $e')),
                data: (rooms) {
                  // Calculate statistics exactly like PHP dashboard
                  final totalRooms = rooms.length;
                  final availableRooms = rooms.where((r) => r.status == 'شاغرة').length;
                  final occupiedRooms = rooms.where((r) => r.status == 'محجوزة').length;
                  final occupancyRate = totalRooms > 0 ? ((occupiedRooms / totalRooms) * 100).round() : 0;
                  
                  final currentGuests = bookingsAsync.asData?.value
                      .where((b) => b.status == 'نشط').length ?? 0;
                  
                  // Calculate today's revenue and expenses
                  final today = DateTime.now();
                  final todayString = '${today.year}-${today.month.toString().padLeft(2, '0')}-${today.day.toString().padLeft(2, '0')}';\n                  \n                  double todayRevenue = 0;\n                  double monthRevenue = 0;\n                  cashAsync.asData?.value.forEach((t) {\n                    if (t.transactionType == 'income') {\n                      final transactionDate = DateTime.tryParse(t.transactionTime);\n                      if (transactionDate != null) {\n                        final transactionDateString = '${transactionDate.year}-${transactionDate.month.toString().padLeft(2, '0')}-${transactionDate.day.toString().padLeft(2, '0')}';\n                        if (transactionDateString == todayString) {\n                          todayRevenue += t.amount;\n                        }\n                        if (transactionDate.year == today.year && transactionDate.month == today.month) {\n                          monthRevenue += t.amount;\n                        }\n                      }\n                    }\n                  });\n                  \n                  double todayExpenses = 0;\n                  double monthExpenses = 0;\n                  expensesAsync.asData?.value.forEach((e) {\n                    final expenseDate = DateTime.tryParse(e.date);\n                    if (expenseDate != null) {\n                      final expenseDateString = '${expenseDate.year}-${expenseDate.month.toString().padLeft(2, '0')}-${expenseDate.day.toString().padLeft(2, '0')}';\n                      if (expenseDateString == todayString) {\n                        todayExpenses += e.amount;\n                      }\n                      if (expenseDate.year == today.year && expenseDate.month == today.month) {\n                        monthExpenses += e.amount;\n                      }\n                    }\n                  });\n                  \n                  final todayProfit = todayRevenue - todayExpenses;\n                  final monthProfit = monthRevenue - monthExpenses;\n                  \n                  return Column(\n                    children: [\n                      // First row - Room statistics\n                      Row(\n                        children: [\n                          Expanded(\n                            child: StatCard(\n                              title: 'إجمالي الغرف',\n                              value: totalRooms.toString(),\n                              icon: Icons.hotel,\n                              color: AppColors.infoColor,\n                              subtitle: 'جميع الغرف',\n                            ),\n                          ),\n                          Expanded(\n                            child: StatCard(\n                              title: 'الغرف المتاحة',\n                              value: availableRooms.toString(),\n                              icon: Icons.hotel_outlined,\n                              color: AppColors.successColor,\n                              subtitle: 'شاغرة',\n                            ),\n                          ),\n                        ],\n                      ),\n                      \n                      // Second row - Occupancy and guests\n                      Row(\n                        children: [\n                          Expanded(\n                            child: StatCard(\n                              title: 'الغرف المحجوزة',\n                              value: occupiedRooms.toString(),\n                              icon: Icons.bed,\n                              color: AppColors.dangerColor,\n                              subtitle: 'محجوزة',\n                            ),\n                          ),\n                          Expanded(\n                            child: StatCard(\n                              title: 'نسبة الإشغال',\n                              value: '$occupancyRate%',\n                              icon: Icons.pie_chart,\n                              color: AppColors.warningColor,\n                              subtitle: 'النسبة الحالية',\n                            ),\n                          ),\n                        ],\n                      ),\n                      \n                      // Third row - Guests and revenue\n                      Row(\n                        children: [\n                          Expanded(\n                            child: StatCard(\n                              title: 'النزلاء الحاليين',\n                              value: currentGuests.toString(),\n                              icon: Icons.group,\n                              color: AppColors.primaryColor,\n                              subtitle: 'نشط',\n                            ),\n                          ),\n                          Expanded(\n                            child: StatCard(\n                              title: 'إيرادات اليوم',\n                              value: todayRevenue.toStringAsFixed(0),\n                              icon: Icons.trending_up,\n                              color: AppColors.successColor,\n                              subtitle: 'ريال يمني',\n                            ),\n                          ),\n                        ],\n                      ),\n                      \n                      // Fourth row - Monthly statistics\n                      Row(\n                        children: [\n                          Expanded(\n                            child: StatCard(\n                              title: 'إيرادات الشهر',\n                              value: monthRevenue.toStringAsFixed(0),\n                              icon: Icons.account_balance_wallet,\n                              color: AppColors.successColor,\n                              subtitle: 'ريال يمني',\n                            ),\n                          ),\n                          Expanded(\n                            child: StatCard(\n                              title: 'مصروفات اليوم',\n                              value: todayExpenses.toStringAsFixed(0),\n                              icon: Icons.trending_down,\n                              color: AppColors.dangerColor,\n                              subtitle: 'ريال يمني',\n                            ),\n                          ),\n                        ],\n                      ),\n                      \n                      // Fifth row - Expenses and profit\n                      Row(\n                        children: [\n                          Expanded(\n                            child: StatCard(\n                              title: 'مصروفات الشهر',\n                              value: monthExpenses.toStringAsFixed(0),\n                              icon: Icons.receipt_long,\n                              color: AppColors.dangerColor,\n                              subtitle: 'ريال يمني',\n                            ),\n                          ),\n                          Expanded(\n                            child: StatCard(\n                              title: 'صافي الربح اليومي',\n                              value: todayProfit.toStringAsFixed(0),\n                              icon: todayProfit >= 0 ? Icons.trending_up : Icons.trending_down,\n                              color: todayProfit >= 0 ? AppColors.successColor : AppColors.dangerColor,\n                              subtitle: 'ريال يمني',\n                            ),\n                          ),\n                        ],\n                      ),\n                      \n                      // Sixth row - Monthly profit\n                      Row(\n                        children: [\n                          Expanded(\n                            child: StatCard(\n                              title: 'صافي الربح الشهري',\n                              value: monthProfit.toStringAsFixed(0),\n                              icon: monthProfit >= 0 ? Icons.trending_up : Icons.trending_down,\n                              color: monthProfit >= 0 ? AppColors.successColor : AppColors.dangerColor,\n                              subtitle: 'ريال يمني',\n                            ),\n                          ),\n                          Expanded(\n                            child: Container(), // Empty space for balance\n                          ),\n                        ],\n                      ),\n                    ],\n                  );\n                },\n              );\n            },\n          ),\n          \n          const SizedBox(height: 32),\n          \n          // Recent activity section - matching PHP layout\n          AdminCard(\n            title: 'النشاط الحديث',\n            child: Column(\n              children: [\n                _buildRecentActivityItem(\n                  'حجوزات جديدة',\n                  'تم إضافة 3 حجوزات جديدة اليوم',\n                  Icons.assignment,\n                  AppColors.successColor,\n                ),\n                const Divider(),\n                _buildRecentActivityItem(\n                  'مدفوعات مستلمة',\n                  'تم استلام دفعات بقيمة 15000 ريال',\n                  Icons.payment,\n                  AppColors.primaryColor,\n                ),\n                const Divider(),\n                _buildRecentActivityItem(\n                  'غرف تم تسجيل المغادرة',\n                  'تم تسجيل مغادرة 2 حجز اليوم',\n                  Icons.logout,\n                  AppColors.warningColor,\n                ),\n              ],\n            ),\n          ),\n          \n          const SizedBox(height: 32),\n          \n          // Quick actions section - matching PHP style\n          AdminCard(\n            title: 'إجراءات سريعة',\n            child: Wrap(\n              spacing: 16,\n              runSpacing: 16,\n              children: [\n                _buildQuickActionButton(\n                  'حجز جديد',\n                  Icons.add,\n                  AppColors.successColor,\n                  () => {}, // Navigation handled by sidebar\n                ),\n                _buildQuickActionButton(\n                  'إدارة الغرف',\n                  Icons.bed,\n                  AppColors.primaryColor,\n                  () => {},\n                ),\n                _buildQuickActionButton(\n                  'إدارة المدفوعات',\n                  Icons.payment,\n                  AppColors.warningColor,\n                  () => {},\n                ),\n                _buildQuickActionButton(\n                  'التقارير',\n                  Icons.bar_chart,\n                  AppColors.infoColor,\n                  () => {},\n                ),\n              ],\n            ),\n          ),\n        ],\n      ),\n    );\n  }\n  \n  Widget _buildRecentActivityItem(\n    String title,\n    String subtitle,\n    IconData icon,\n    Color color,\n  ) {\n    return ListTile(\n      leading: Container(\n        padding: const EdgeInsets.all(8),\n        decoration: BoxDecoration(\n          color: color.withOpacity(0.1),\n          borderRadius: BorderRadius.circular(8),\n        ),\n        child: Icon(icon, color: color),\n      ),\n      title: Text(\n        title,\n        style: const TextStyle(fontWeight: FontWeight.w600),\n      ),\n      subtitle: Text(subtitle),\n      contentPadding: EdgeInsets.zero,\n    );\n  }\n  \n  Widget _buildQuickActionButton(\n    String title,\n    IconData icon,\n    Color color,\n    VoidCallback onTap,\n  ) {\n    return InkWell(\n      onTap: onTap,\n      borderRadius: BorderRadius.circular(8),\n      child: Container(\n        width: 140,\n        padding: const EdgeInsets.symmetric(vertical: 16, horizontal: 12),\n        decoration: BoxDecoration(\n          border: Border.all(color: color.withOpacity(0.3)),\n          borderRadius: BorderRadius.circular(8),\n          color: color.withOpacity(0.05),\n        ),\n        child: Column(\n          children: [\n            Icon(icon, size: 32, color: color),\n            const SizedBox(height: 8),\n            Text(\n              title,\n              style: TextStyle(\n                color: color,\n                fontWeight: FontWeight.w600,\n                fontSize: 12,\n              ),\n              textAlign: TextAlign.center,\n            ),\n          ],\n        ),\n      ),\n    );\n  }\n}