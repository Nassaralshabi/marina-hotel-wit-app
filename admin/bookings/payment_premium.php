<?php
ob_start();
session_start();
require '../../includes/db.php';
require_once '../../includes/functions.php';

// ุงูุชุญูู ูู ุตุญุฉ ูุนุฑู ุงูุญุฌุฒ
$booking_id = intval($_GET['id'] ?? 0);
if ($booking_id <= 0) {
    die('ุฎุทุฃ: ุฑูู ุงูุญุฌุฒ ุบูุฑ ุตุงูุญ');
}

// ุฌูุจ ุจูุงูุงุช ุงูุญุฌุฒ ูุน ุงูุชุญูู ูู ูุฌูุฏู
$booking_query = "
    SELECT b.booking_id, b.guest_name, b.guest_phone, b.room_number,
           b.checkin_date, b.checkout_date, b.actual_checkout, r.price AS room_price,
           b.status,
           IFNULL((SELECT SUM(p.amount) FROM payment p WHERE p.booking_id = b.booking_id), 0) AS paid_amount
    FROM bookings b
    LEFT JOIN rooms r ON b.room_number = r.room_number
    WHERE b.booking_id = ? LIMIT 1
";

$stmt = $conn->prepare($booking_query);
if (!$stmt) {
    die('ุฎุทุฃ ูู ุฅุนุฏุงุฏ ุงูุงุณุชุนูุงู: ' . $conn->error);
}

$stmt->bind_param('i', $booking_id);
$stmt->execute();
$booking_res = $stmt->get_result();

if ($booking_res->num_rows === 0) {
    die('ุฎุทุฃ: ุงูุญุฌุฒ ุบูุฑ ููุฌูุฏ');
}

$booking = $booking_res->fetch_assoc();

// ุญุณุงุจ ุนุฏุฏ ุงูููุงูู ูุงูุชูููุฉ ุงูุฅุฌูุงููุฉ
$checkin = new DateTime($booking['checkin_date']);
$checkout = $booking['actual_checkout'] ? new DateTime($booking['actual_checkout']) : new DateTime();
$nights = $checkout->diff($checkin)->days ?: 1;

$total_price = $booking['room_price'] * $nights;
$paid_amount = $booking['paid_amount'];
$remaining = max(0, $total_price - $paid_amount);

// ูุนุงูุฌุฉ ุชุณุฌูู ุงููุบุงุฏุฑุฉ
if (isset($_POST['checkout'])) {
    if ($remaining > 0) {
        $_SESSION['flash'] = [
            'type' => 'danger',
            'message' => 'ูุง ูููู ุชุณุฌูู ุงููุบุงุฏุฑุฉ ูุจู ุชุณุฏูุฏ ูุงูุฉ ุงููุณุชุญูุงุช. ุงููุจูุบ ุงููุชุจูู: ' . number_format($remaining, 0) . ' ุฑูุงู'
        ];
    } else {
        $conn->begin_transaction();
        try {
            $update_booking = $conn->prepare("UPDATE bookings SET status='ุดุงุบุฑุฉ', actual_checkout=NOW() WHERE booking_id=?");
            $update_booking->bind_param('i', $booking_id);
            $update_booking->execute();

            $update_room = $conn->prepare("UPDATE rooms SET status='ุดุงุบุฑุฉ' WHERE room_number=?");
            $update_room->bind_param('s', $booking['room_number']);
            $update_room->execute();

            $conn->commit();

            $_SESSION['flash'] = [
                'type' => 'success',
                'message' => 'ุชู ุชุณุฌูู ูุบุงุฏุฑุฉ ุงููุฒูู ุจูุฌุงุญ ูุชู ุชุญุฑูุฑ ุงูุบุฑูุฉ.'
            ];
            
            header("Location: payment_premium.php?id=$booking_id");
            exit();
        } catch (Exception $e) {
            $conn->rollback();
            $_SESSION['flash'] = [
                'type' => 'danger',
                'message' => 'ุฎุทุฃ ุฃุซูุงุก ุชุณุฌูู ุงููุบุงุฏุฑุฉ: ' . $e->getMessage()
            ];
        }
    }
}

// ูุนุงูุฌุฉ ุฅุถุงูุฉ ุฏูุนุฉ ุฌุฏูุฏุฉ
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['submit_payment'])) {
    $amount = floatval($_POST['amount'] ?? 0);
    $payment_date = $_POST['payment_date'] ?? date('Y-m-d H:i:s');
    $payment_method = $conn->real_escape_string($_POST['payment_method'] ?? 'ููุฏู');
    $notes = $conn->real_escape_string($_POST['notes'] ?? '');

    if ($amount <= 0) {
        $_SESSION['flash'] = [
            'type' => 'danger',
            'message' => 'ุงููุจูุบ ูุฌุจ ุฃู ูููู ุฃูุจุฑ ูู ุตูุฑ'
        ];
    } elseif ($amount > $remaining) {
        $_SESSION['flash'] = [
            'type' => 'danger',
            'message' => 'ุงููุจูุบ ูุฌุจ ุฃู ูุง ูุชุฌุงูุฒ ุงููุชุจูู: ' . number_format($remaining, 0) . ' ุฑูุงู'
        ];
    } else {
        $insert_payment = $conn->prepare("INSERT INTO payment (booking_id, amount, payment_date, payment_method, notes) VALUES (?, ?, ?, ?, ?)");
        $insert_payment->bind_param('idsss', $booking_id, $amount, $payment_date, $payment_method, $notes);

        if ($insert_payment->execute()) {
            $remaining_after = max(0, $remaining - $amount);
            
            $whatsapp_message = sprintf(
                "๐จ ูุงุฑููุง ููุชู\n\nุนุฒูุฒู %sุ\n\nโ ุชู ุงุณุชูุงู ุฏูุนุฉ ุจูููุฉ %.2f ุฑูุงู\n๐ ุฑูู ุงูุญุฌุฒ: %d\n๐ฐ ุงููุจูุบ ุงููุชุจูู: %.2f ุฑูุงู\n\nุดูุฑุงู ูู ๐",
                $booking['guest_name'], 
                $amount, 
                $booking_id, 
                $remaining_after
            );
            
            $whatsapp_result = send_yemeni_whatsapp($booking['guest_phone'], $whatsapp_message);
            $whatsapp_status = '';
            
            if (is_array($whatsapp_result) && isset($whatsapp_result['status']) && $whatsapp_result['status'] === 'sent') {
                $whatsapp_status = ' ูุชู ุฅุฑุณุงู ุฅุดุนุงุฑ ููุนููู ุนุจุฑ ุงููุงุชุณุงุจ.';
            } else {
                $whatsapp_status = ' ูููู ูู ูุชู ุฅุฑุณุงู ุฅุดุนุงุฑ ููุนููู.';
            }

            $_SESSION['flash'] = [
                'type' => 'success',
                'message' => 'ุชู ุชุณุฌูู ุงูุฏูุนุฉ ุจูุฌุงุญ' . $whatsapp_status
            ];
            
            header("Location: payment_premium.php?id=$booking_id");
            exit();
        } else {
            $_SESSION['flash'] = [
                'type' => 'danger',
                'message' => 'ุฎุทุฃ ูู ุฅุถุงูุฉ ุงูุฏูุนุฉ: ' . $conn->error
            ];
        }
    }
}

// ุฌูุจ ุณุฌู ุงูุฏูุนุงุช
$payments_query = "SELECT * FROM payment WHERE booking_id=? ORDER BY payment_date DESC";
$stmt_payments = $conn->prepare($payments_query);
$stmt_payments->bind_param('i', $booking_id);
$stmt_payments->execute();
$payments_result = $stmt_payments->get_result();

// ุชุญุฏูุซ ุงูุจูุงูุงุช ุจุนุฏ ุงููุนุงูุฌุฉ
$stmt = $conn->prepare($booking_query);
$stmt->bind_param('i', $booking_id);
$stmt->execute();
$booking_res = $stmt->get_result();
$booking = $booking_res->fetch_assoc();

$checkin = new DateTime($booking['checkin_date']);
$checkout = $booking['actual_checkout'] ? new DateTime($booking['actual_checkout']) : new DateTime();
$nights = $checkout->diff($checkin)->days ?: 1;

$total_price = $booking['room_price'] * $nights;
$paid_amount = $booking['paid_amount'];
$remaining = max(0, $total_price - $paid_amount);
?>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>๐ฐ ุฅุฏุงุฑุฉ ุงูุฏูุนุงุช - ูุงุฑููุง ููุชู</title>
    <link href="../../css/bootstrap.min.css" rel="stylesheet">
    <link href="../../includes/css/fontawesome.min.css" rel="stylesheet">
    <link href="../../includes/css/cairo-font.css" rel="stylesheet">
    <link href="../../includes/css/custom.css" rel="stylesheet">
    <!-- ุชู ููู ุฌููุน ุงูุฃููุงุท ุฅูู ูููุงุช CSS ูููุตูุฉ ูุชุนูู ุจุฏูู ุฅูุชุฑูุช -->
</head>
<body>

<!-- ุนูุงุตุฑ ููุนููุฉ ููุชุฃุซูุฑ ุงูุจุตุฑู -->
<div class="floating-elements">
    <i class="fas fa-coins floating-element" style="top: 10%; left: 10%; font-size: 2em; animation-delay: 0s;"></i>
    <i class="fas fa-hotel floating-element" style="top: 20%; right: 15%; font-size: 1.5em; animation-delay: 1s;"></i>
    <i class="fas fa-money-bill-wave floating-element" style="bottom: 30%; left: 20%; font-size: 1.8em; animation-delay: 2s;"></i>
    <i class="fas fa-credit-card floating-element" style="bottom: 20%; right: 10%; font-size: 1.3em; animation-delay: 3s;"></i>
</div>

<!-- Toast Notifications -->
<?php if (isset($_SESSION['flash'])): ?>
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
    <div id="flashToast" class="toast align-items-center text-bg-<?= $_SESSION['flash']['type'] ?> border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-<?= $_SESSION['flash']['type'] === 'success' ? 'check-circle' : 'exclamation-triangle' ?> me-2"></i>
                <?= htmlspecialchars($_SESSION['flash']['message']) ?>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>
<?php unset($_SESSION['flash']); endif; ?>

<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            
            <!-- ุงูุดุนุงุฑ ูุงูุนููุงู ุงูุฑุฆูุณู -->
            <div class="main-logo">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <div class="hotel-logo">
                            <i class="fas fa-hotel"></i>
                        </div>
                        <div>
                            <h1 class="hotel-name mb-0">ูุงุฑููุง ููุชู</h1>
                            <p class="hotel-subtitle mb-0">
                                <i class="fas fa-money-check-alt me-2"></i>
                                ุฅุฏุงุฑุฉ ุงูุฏูุนุงุช - ุญุฌุฒ #<?= $booking_id ?>
                            </p>
                        </div>
                    </div>
                    <div class="d-flex align-items-center">
                        <svg class="progress-ring" style="--progress: <?= $total_price > 0 ? round(($paid_amount / $total_price) * 100) : 0 ?>">
                            <circle cx="30" cy="30" r="25" class="progress"></circle>
                        </svg>
                        <a href="list.php" class="btn btn-outline-light ms-3">
                            <i class="fas fa-arrow-right me-2"></i>ุงูุนูุฏุฉ
                        </a>
                    </div>
                </div>
            </div>

            <!-- ููุฎุต ุงูุฏูุนุงุช ุงููุญุณู -->
            <div class="summary-card">
                <div class="d-flex align-items-center justify-content-between mb-4">
                    <h4 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i>ุงูููุฎุต ุงููุงูู
                    </h4>
                    <div class="d-flex align-items-center">
                        <span class="badge <?= $booking['status'] === 'ุดุงุบุฑุฉ' ? 'bg-success' : 'bg-warning' ?> me-3">
                            <?= htmlspecialchars($booking['status']) ?>
                        </span>
                        <span class="opacity-75">๐จ ุงูุบุฑูุฉ <?= htmlspecialchars($booking['room_number']) ?></span>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-3">
                        <div class="summary-item">
                            <h6>๐ฐ ุฅุฌูุงูู ุงููุจูุบ</h6>
                            <h3><?= number_format($total_price, 0) ?> ุฑูุงู</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="summary-item">
                            <h6>โ ุงููุจูุบ ุงููุฏููุน</h6>
                            <h3 class="text-success"><?= number_format($paid_amount, 0) ?> ุฑูุงู</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="summary-item">
                            <h6>โณ ุงููุจูุบ ุงููุชุจูู</h6>
                            <h3 class="text-warning"><?= number_format($remaining, 0) ?> ุฑูุงู</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="summary-item">
                            <h6>๐ ูุณุจุฉ ุงูุฏูุน</h6>
                            <h3 class="text-info"><?= $total_price > 0 ? round(($paid_amount / $total_price) * 100, 1) : 0 ?>%</h3>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="compact-info">
                            <p><strong>๐ค ุงููุฒูู:</strong> <?= htmlspecialchars($booking['guest_name']) ?></p>
                            <p><strong>๐ฑ ุงููุงุชู:</strong> <?= htmlspecialchars($booking['guest_phone']) ?></p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="compact-info">
                            <p><strong>๐ ุชุงุฑูุฎ ุงูุฏุฎูู:</strong> <?= date('Y-m-d', strtotime($booking['checkin_date'])) ?></p>
                            <p><strong>๐ ุนุฏุฏ ุงูููุงูู:</strong> <?= $nights ?> ูููุฉ</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- ุฅุถุงูุฉ ุฏูุนุฉ ุฌุฏูุฏุฉ -->
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-plus-circle me-2"></i>ุฅุถุงูุฉ ุฏูุนุฉ ุฌุฏูุฏุฉ
                            </h5>
                        </div>
                        <div class="card-body">
                            <?php if ($remaining > 0): ?>
                            <form method="POST" action="">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="amount" class="form-label">๐ฐ ุงููุจูุบ (ุฑูุงู)</label>
                                            <input type="number" 
                                                   class="form-control" 
                                                   id="amount" 
                                                   name="amount" 
                                                   min="1" 
                                                   max="<?= $remaining ?>" 
                                                   step="0.01" 
                                                   required
                                                   placeholder="ุฃุฏุฎู ุงููุจูุบ">
                                            <div class="form-text">ุงูุญุฏ ุงูุฃูุตู: <?= number_format($remaining, 0) ?> ุฑูุงู</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="payment_method" class="form-label">๐ณ ุทุฑููุฉ ุงูุฏูุน</label>
                                            <select class="form-select" id="payment_method" name="payment_method" required>
                                                <option value="ููุฏู">๐ต ููุฏู</option>
                                                <option value="ุจุทุงูุฉ ุงุฆุชูุงู">๐ณ ุจุทุงูุฉ ุงุฆุชูุงู</option>
                                                <option value="ุชุญููู ุจููู">๐ฆ ุชุญููู ุจููู</option>
                                                <option value="ุดูู">๐ ุดูู</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="payment_date" class="form-label">๐ ุชุงุฑูุฎ ุงูุฏูุน</label>
                                    <input type="datetime-local" 
                                           class="form-control" 
                                           id="payment_date" 
                                           name="payment_date" 
                                           value="<?= date('Y-m-d\TH:i') ?>" 
                                           required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="notes" class="form-label">๐ ููุงุญุธุงุช</label>
                                    <textarea class="form-control" 
                                              id="notes" 
                                              name="notes" 
                                              rows="2" 
                                              placeholder="ุฃู ููุงุญุธุงุช ุฅุถุงููุฉ..."></textarea>
                                </div>
                                
                                <button type="submit" name="submit_payment" class="btn btn-primary w-100">
                                    <i class="fas fa-save me-2"></i>ุชุณุฌูู ุงูุฏูุนุฉ
                                </button>
                            </form>
                            <?php else: ?>
                            <div class="alert alert-success text-center">
                                <i class="fas fa-trophy fa-3x mb-3 text-warning"></i>
                                <h5>๐ ุชู ุชุณุฏูุฏ ูุงูู ุงููุจูุบ</h5>
                                <p class="mb-0">ุชู ุงุณุชูุงู ุฌููุน ุงูุฏูุนุงุช ุงููุทููุจุฉ ููุฐุง ุงูุญุฌุฒ ุจูุฌุงุญ!</p>
                            </div>
                            <?php endif; ?>
                        </div>
                    </div>
                </div>

                <!-- ุณุฌู ุงูุฏูุนุงุช -->
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-history me-2"></i>ุณุฌู ุงูุฏูุนุงุช
                            </h5>
                        </div>
                        <div class="card-body">
                            <?php if ($payments_result->num_rows > 0): ?>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>ุงูุชุงุฑูุฎ</th>
                                            <th>ุงููุจูุบ</th>
                                            <th>ุงูุทุฑููุฉ</th>
                                            <th>ุงูููุงุญุธุงุช</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <?php while ($payment = $payments_result->fetch_assoc()): ?>
                                        <tr>
                                            <td>
                                                <small class="text-muted"><?= date('m/d', strtotime($payment['payment_date'])) ?></small><br>
                                                <small><?= date('H:i', strtotime($payment['payment_date'])) ?></small>
                                            </td>
                                            <td>
                                                <strong class="text-success"><?= number_format($payment['amount'], 0) ?></strong>
                                                <small class="text-muted d-block">ุฑูุงู</small>
                                            </td>
                                            <td>
                                                <span class="badge bg-secondary">
                                                    <?= htmlspecialchars($payment['payment_method']) ?>
                                                </span>
                                            </td>
                                            <td>
                                                <small><?= htmlspecialchars($payment['notes']) ?: '-' ?></small>
                                            </td>
                                        </tr>
                                        <?php endwhile; ?>
                                    </tbody>
                                </table>
                            </div>
                            <?php else: ?>
                            <div class="alert alert-info text-center">
                                <i class="fas fa-info-circle fa-3x mb-3 text-primary"></i>
                                <h6>ูุง ุชูุฌุฏ ุฏูุนุงุช ูุณุฌูุฉ</h6>
                                <p class="mb-0">ูู ูุชู ุชุณุฌูู ุฃู ุฏูุนุงุช ููุฐุง ุงูุญุฌุฒ ุจุนุฏ.</p>
                            </div>
                            <?php endif; ?>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ูุณู ุงููุบุงุฏุฑุฉ -->
            <?php if ($booking['status'] !== 'ุดุงุบุฑุฉ'): ?>
            <div class="card">
                <div class="card-header" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);">
                    <h5 class="mb-0">
                        <i class="fas fa-sign-out-alt me-2"></i>ุชุณุฌูู ุงููุบุงุฏุฑุฉ
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-lg-8">
                            <?php if ($remaining > 0): ?>
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>ุชูุจูู:</strong> ูุง ูููู ุชุณุฌูู ุงููุบุงุฏุฑุฉ ูุจู ุชุณุฏูุฏ ูุงูู ุงููุจูุบ. 
                                ุงููุจูุบ ุงููุชุจูู: <strong><?= number_format($remaining, 0) ?> ุฑูุงู</strong>
                            </div>
                            <?php else: ?>
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle me-2"></i>
                                <strong>๐ ุฌุงูุฒ ูููุบุงุฏุฑุฉ!</strong> ุชู ุชุณุฏูุฏ ูุงูู ุงููุจูุบ ุงููุทููุจ.
                            </div>
                            <?php endif; ?>
                        </div>
                        <div class="col-lg-4 text-center">
                            <?php if ($remaining == 0): ?>
                            <form method="POST" action="">
                                <button type="submit" name="checkout" class="btn btn-success btn-lg" onclick="return confirm('๐ค ูู ุฃูุช ูุชุฃูุฏ ูู ุชุณุฌูู ูุบุงุฏุฑุฉ ุงููุฒููุ')">
                                    <i class="fas fa-sign-out-alt me-2"></i>ุชุณุฌูู ุงููุบุงุฏุฑุฉ
                                </button>
                            </form>
                            <?php else: ?>
                            <button type="button" class="btn btn-secondary btn-lg" disabled>
                                <i class="fas fa-lock me-2"></i>ุบูุฑ ูุชุงุญ
                            </button>
                            <?php endif; ?>
                        </div>
                    </div>
                </div>
            </div>
            <?php else: ?>
            <div class="card">
                <div class="card-body text-center">
                    <div class="alert alert-info">
                        <i class="fas fa-check-circle fa-3x mb-3 text-success"></i>
                        <h5>โ ุชู ุชุณุฌูู ุงููุบุงุฏุฑุฉ</h5>
                        <p class="mb-0">ุชู ุชุณุฌูู ูุบุงุฏุฑุฉ ุงููุฒูู ูุชุญุฑูุฑ ุงูุบุฑูุฉ ุจูุฌุงุญ.</p>
                    </div>
                </div>
            </div>
            <?php endif; ?>

        </div>
    </div>
</div>

<script src="../../includes/js/bootstrap.bundle.min.js"></script>
<script src="../../includes/js/custom.js"></script>
<script>
// Marina Hotel Payment System - Premium Features
document.addEventListener('DOMContentLoaded', function() {
    console.log('๐จ Marina Hotel Payment System Premium - Starting...');
    
    // Initialize payment system specific features
    PaymentSystem.init();
    
    console.log('โ Marina Hotel Payment System Premium - Ready!');
});

// Payment System Module
const PaymentSystem = {
    init: function() {
        this.initializeToasts();
        this.setupPaymentValidation();
        this.setupProgressRing();
        this.initializeCounters();
        this.setupFormEnhancements();
    },

    initializeToasts: function() {
        const toastElement = document.getElementById('flashToast');
        if (toastElement && window.bootstrap) {
            const toast = new bootstrap.Toast(toastElement, { 
                delay: 5000,
                autohide: true 
            });
            toast.show();
            
            // Add custom animation
            toastElement.style.animation = 'slideInRight 0.5s ease-out';
        }
    },

    setupPaymentValidation: function() {
        const amountInput = document.getElementById('amount');
        if (amountInput) {
            amountInput.addEventListener('input', this.validateAmount);
            amountInput.addEventListener('focus', function() {
                this.parentElement.style.transform = 'scale(1.02)';
                this.parentElement.style.transition = 'transform 0.3s ease';
            });
            amountInput.addEventListener('blur', function() {
                this.parentElement.style.transform = 'scale(1)';
            });
        }

        // Phone validation
        const phoneInputs = document.querySelectorAll('input[type="tel"]');
        phoneInputs.forEach(input => {
            input.addEventListener('input', this.formatYemeniPhone);
        });
    },

    validateAmount: function() {
        const value = parseFloat(this.value);
        const max = parseFloat(this.getAttribute('max'));
        const min = parseFloat(this.getAttribute('min')) || 0;

        this.classList.remove('is-valid', 'is-invalid');

        if (isNaN(value) || value <= min) {
            this.classList.add('is-invalid');
            this.setCustomValidity('ุงููุจูุบ ูุฌุจ ุฃู ูููู ุฃูุจุฑ ูู ' + min);
            PaymentSystem.showValidationFeedback(this, 'error', 'ุงููุจูุบ ูุฌุจ ุฃู ูููู ุฃูุจุฑ ูู ุตูุฑ');
        } else if (value > max) {
            this.classList.add('is-invalid');
            this.setCustomValidity('ุงููุจูุบ ูุง ูููู ุฃู ูุชุฌุงูุฒ ' + max.toLocaleString() + ' ุฑูุงู');
            PaymentSystem.showValidationFeedback(this, 'error', 'ุงููุจูุบ ูุชุฌุงูุฒ ุงูุญุฏ ุงููุณููุญ');
        } else {
            this.classList.add('is-valid');
            this.setCustomValidity('');
            PaymentSystem.showValidationFeedback(this, 'success', 'ุงููุจูุบ ุตุญูุญ โ');
        }
    },

    formatYemeniPhone: function() {
        let value = this.value.replace(/[^0-9+]/g, '');
        
        // Format Yemeni numbers
        if (value.startsWith('7') && value.length <= 9) {
            value = value.replace(/(\d{3})(\d{3})(\d{3})/, '$1 $2 $3');
        } else if (value.startsWith('967')) {
            value = value.replace(/(\d{3})(\d{1})(\d{3})(\d{3})(\d{3})/, '$1 $2 $3 $4 $5');
        }
        
        this.value = value;

        // Validate
        if (window.MarinaHotel && window.MarinaHotel.Utils.validateYemeniPhone(value)) {
            this.classList.add('is-valid');
            this.classList.remove('is-invalid');
        } else if (value.length > 3) {
            this.classList.add('is-invalid');
            this.classList.remove('is-valid');
        }
    },

    showValidationFeedback: function(input, type, message) {
        let feedback = input.parentElement.querySelector('.validation-feedback');
        
        if (!feedback) {
            feedback = document.createElement('div');
            feedback.className = 'validation-feedback small mt-1';
            input.parentElement.appendChild(feedback);
        }

        feedback.className = `validation-feedback small mt-1 text-${type === 'error' ? 'danger' : 'success'}`;
        feedback.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'} me-1"></i>${message}`;
        
        // Animate
        feedback.style.opacity = '0';
        feedback.style.transform = 'translateY(-10px)';
        
        requestAnimationFrame(() => {
            feedback.style.transition = 'all 0.3s ease';
            feedback.style.opacity = '1';
            feedback.style.transform = 'translateY(0)';
        });
    },

    setupProgressRing: function() {
        const progressRing = document.querySelector('.progress-ring .progress');
        if (progressRing) {
            const progressValue = progressRing.closest('svg').style.getPropertyValue('--progress') || '0';
            
            // Animate progress ring
            setTimeout(() => {
                progressRing.style.transition = 'stroke-dashoffset 2s ease-in-out';
                progressRing.style.strokeDashoffset = `calc(157 - (157 * ${progressValue}) / 100)`;
            }, 500);
        }
    },

    initializeCounters: function() {
        const counters = document.querySelectorAll('.summary-item h3');
        
        counters.forEach((counter, index) => {
            const text = counter.textContent;
            const numbers = text.match(/[\d,]+/);
            
            if (numbers) {
                const targetValue = parseInt(numbers[0].replace(/,/g, ''));
                const suffix = text.replace(/[\d,\s]+/, '');
                
                if (targetValue > 0) {
                    this.animateCounter(counter, 0, targetValue, suffix, 2000 + (index * 200));
                }
            }
        });
    },

    animateCounter: function(element, start, end, suffix, duration) {
        const startTime = performance.now();
        
        const animate = (currentTime) => {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            
            // Easing function
            const easeOutQuart = 1 - Math.pow(1 - progress, 4);
            const current = Math.floor(start + (end - start) * easeOutQuart);
            
            element.textContent = current.toLocaleString('ar-SA') + ' ' + suffix;
            
            if (progress < 1) {
                requestAnimationFrame(animate);
            }
        };
        
        requestAnimationFrame(animate);
    },

    setupFormEnhancements: function() {
        // Auto-update payment date
        const dateInput = document.getElementById('payment_date');
        if (dateInput) {
            // Set current datetime if empty
            if (!dateInput.value) {
                const now = new Date();
                dateInput.value = now.toISOString().slice(0, 16);
            }

            // Update every minute if not focused
            setInterval(() => {
                if (document.activeElement !== dateInput && !dateInput.value) {
                    const now = new Date();
                    dateInput.value = now.toISOString().slice(0, 16);
                }
            }, 60000);
        }

        // Enhanced form submission
        const paymentForm = document.querySelector('form[method="POST"]');
        if (paymentForm) {
            paymentForm.addEventListener('submit', function(e) {
                const submitBtn = this.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ุฌุงุฑู ุงูุชุณุฌูู...';
                    submitBtn.disabled = true;
                    
                    // Re-enable after 5 seconds as fallback
                    setTimeout(() => {
                        submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>ุชุณุฌูู ุงูุฏูุนุฉ';
                        submitBtn.disabled = false;
                    }, 5000);
                }
            });
        }

        // Enhanced checkout confirmation
        const checkoutForm = document.querySelector('form[name="checkout"], button[name="checkout"]');
        if (checkoutForm) {
            checkoutForm.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Create custom confirmation dialog
                PaymentSystem.showCheckoutConfirmation(() => {
                    // Submit the form
                    if (this.closest('form')) {
                        this.closest('form').submit();
                    } else {
                        // Create and submit form
                        const form = document.createElement('form');
                        form.method = 'POST';
                        form.action = '';
                        
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'checkout';
                        input.value = '1';
                        
                        form.appendChild(input);
                        document.body.appendChild(form);
                        form.submit();
                    }
                });
            });
        }
    },

    showCheckoutConfirmation: function(callback) {
        // Create custom modal for checkout confirmation
        const modalHTML = `
            <div class="modal fade" id="checkoutModal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content" style="border-radius: 20px; border: none;">
                        <div class="modal-header" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white; border-radius: 20px 20px 0 0;">
                            <h5 class="modal-title">
                                <i class="fas fa-sign-out-alt me-2"></i>
                                ุชุฃููุฏ ุชุณุฌูู ุงููุบุงุฏุฑุฉ
                            </h5>
                        </div>
                        <div class="modal-body text-center" style="padding: 30px;">
                            <div class="mb-4">
                                <i class="fas fa-question-circle fa-4x text-warning mb-3"></i>
                                <h4>ูู ุฃูุช ูุชุฃูุฏ ูู ุชุณุฌูู ูุบุงุฏุฑุฉ ุงููุฒููุ</h4>
                                <p class="text-muted">ูุฐุง ุงูุฅุฌุฑุงุก ูุง ูููู ุงูุชุฑุงุฌุน ุนูู ูุณูุชู ุชุญุฑูุฑ ุงูุบุฑูุฉ ููุงุฆูุงู.</p>
                            </div>
                        </div>
                        <div class="modal-footer justify-content-center" style="border: none; padding: 20px 30px 30px;">
                            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">
                                <i class="fas fa-times me-2"></i>ุฅูุบุงุก
                            </button>
                            <button type="button" class="btn btn-danger" id="confirmCheckout">
                                <i class="fas fa-check me-2"></i>ุชุฃููุฏ ุงููุบุงุฏุฑุฉ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Remove existing modal
        const existingModal = document.getElementById('checkoutModal');
        if (existingModal) {
            existingModal.remove();
        }

        // Add new modal
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        const modal = document.getElementById('checkoutModal');
        
        // Setup event listeners
        document.getElementById('confirmCheckout').addEventListener('click', function() {
            if (window.bootstrap) {
                bootstrap.Modal.getInstance(modal).hide();
            }
            callback();
        });

        // Show modal
        if (window.bootstrap) {
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            // Remove modal after hide
            modal.addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }
    }
};

// Add custom CSS animations
const customStyle = document.createElement('style');
customStyle.textContent = `
    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    .validation-feedback {
        font-size: 0.875em;
        margin-top: 0.25rem;
    }
    
    .modal-content {
        animation: fadeInUp 0.3s ease-out;
    }
    
    @keyframes fadeInUp {
        from { transform: translateY(50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
`;
document.head.appendChild(customStyle);
</script>

</body>
</html>
<?php ob_end_flush(); ?>