<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ´Ø®ÙŠØµ Service Worker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        
        .btn {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        .log {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ØªØ´Ø®ÙŠØµ Service Worker</h1>
        
        <div id="status" class="status info">Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...</div>
        
        <button class="btn" onclick="testServiceWorker()">Ø§Ø®ØªØ¨Ø§Ø± Service Worker</button>
        <button class="btn" onclick="clearCache()">Ù…Ø³Ø­ Cache</button>
        <button class="btn" onclick="reloadPage()" style="background: #28a745;">Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„</button>
        
        <div id="logs" class="log"></div>
        
        <h3>ğŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ØªØµÙØ­:</h3>
        <div id="browserInfo"></div>
    </div>

    <script>
        let logDiv = document.getElementById('logs');
        let statusDiv = document.getElementById('status');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(message, type = 'info') {
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }
        
        function testServiceWorker() {
            log('ğŸ” Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Service Worker...');
            
            // ÙØ­Øµ Ø§Ù„Ø¯Ø¹Ù…
            if (!('serviceWorker' in navigator)) {
                updateStatus('âŒ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Service Worker', 'error');
                log('âŒ Service Worker ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­');
                return;
            }
            
            log('âœ… Service Worker Ù…Ø¯Ø¹ÙˆÙ…');
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ SW
            navigator.serviceWorker.register('./sw.js')
                .then(function(registration) {
                    log('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Service Worker Ø¨Ù†Ø¬Ø§Ø­!');
                    log(`ğŸ“ Scope: ${registration.scope}`);
                    log(`ğŸ“ State: ${registration.active ? registration.active.state : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}`);
                    
                    updateStatus('âœ… Service Worker Ù…Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                    
                    // ÙØ­Øµ Ø§Ù„Ø­Ø§Ù„Ø©
                    if (registration.installing) {
                        log('â³ Service Worker Ù‚ÙŠØ¯ Ø§Ù„ØªØ«Ø¨ÙŠØª...');
                        registration.installing.addEventListener('statechange', function() {
                            log(`ğŸ”„ Ø­Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©: ${this.state}`);
                        });
                    }
                    
                    if (registration.waiting) {
                        log('â¸ï¸ Service Worker ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªÙØ¹ÙŠÙ„');
                    }
                    
                    if (registration.active) {
                        log('âœ… Service Worker Ù†Ø´Ø· ÙˆÙŠØ¹Ù…Ù„');
                    }
                    
                    // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
                    testSWCommunication(registration);
                })
                .catch(function(error) {
                    log(`âŒ ÙØ´Ù„ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Service Worker: ${error.message}`);
                    log(`ğŸ“ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£: ${error.toString()}`);
                    updateStatus('âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Service Worker', 'error');
                    
                    // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´Ø®ÙŠØµ Ø§Ù„Ø³Ø¨Ø¨
                    diagnoseSWError(error);
                });
        }
        
        function testSWCommunication(registration) {
            if (registration.active) {
                log('ğŸ“¤ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Service Worker...');
                
                navigator.serviceWorker.addEventListener('message', function(event) {
                    log(`ğŸ“¥ Ø±Ø³Ø§Ù„Ø© Ù…Ù† SW: ${JSON.stringify(event.data)}`);
                });
                
                // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø±
                registration.active.postMessage({
                    type: 'GET_VERSION'
                });
            }
        }
        
        function diagnoseSWError(error) {
            log('ğŸ” ØªØ´Ø®ÙŠØµ Ø³Ø¨Ø¨ Ø§Ù„Ø®Ø·Ø£...');
            
            // ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„Ù
            fetch('./sw.js')
                .then(response => {
                    if (response.ok) {
                        log(`âœ… Ù…Ù„Ù sw.js Ù…ÙˆØ¬ÙˆØ¯ (${response.status})`);
                        log(`ğŸ“ Content-Type: ${response.headers.get('content-type')}`);
                        
                        return response.text();
                    } else {
                        log(`âŒ Ù…Ù„Ù sw.js ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (${response.status})`);
                    }
                })
                .then(content => {
                    if (content) {
                        log(`ğŸ“„ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù: ${content.length} Ø­Ø±Ù`);
                        
                        // ÙØ­Øµ Ø¨Ø³ÙŠØ· Ù„Ù„Ù…Ø­ØªÙˆÙ‰
                        if (content.includes('addEventListener')) {
                            log('âœ… Ø§Ù„Ù…Ù„Ù ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ event listeners');
                        } else {
                            log('âš ï¸ Ø§Ù„Ù…Ù„Ù Ù‚Ø¯ ÙŠÙƒÙˆÙ† ØªØ§Ù„Ù');
                        }
                    }
                })
                .catch(fetchError => {
                    log(`âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ sw.js: ${fetchError.message}`);
                });
        }
        
        function clearCache() {
            log('ğŸ§¹ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù€ caches...');
            
            if ('caches' in window) {
                caches.keys().then(function(cacheNames) {
                    return Promise.all(
                        cacheNames.map(function(cacheName) {
                            log(`ğŸ—‘ï¸ Ù…Ø³Ø­ cache: ${cacheName}`);
                            return caches.delete(cacheName);
                        })
                    );
                }).then(function() {
                    log('âœ… ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù€ caches');
                    updateStatus('âœ… ØªÙ… Ù…Ø³Ø­ Cache', 'success');
                });
            } else {
                log('âŒ Cache API ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…');
            }
        }
        
        function reloadPage() {
            location.reload();
        }
        
        // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ØªØµÙØ­
        function showBrowserInfo() {
            const browserInfo = document.getElementById('browserInfo');
            browserInfo.innerHTML = `
                <p><strong>Ø§Ù„Ù…ØªØµÙØ­:</strong> ${navigator.userAgent}</p>
                <p><strong>Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„:</strong> ${location.protocol}</p>
                <p><strong>Ø§Ù„Ù…Ø¶ÙŠÙ:</strong> ${location.host}</p>
                <p><strong>Ø§Ù„Ù…Ø³Ø§Ø±:</strong> ${location.pathname}</p>
                <p><strong>Service Worker Ù…Ø¯Ø¹ÙˆÙ…:</strong> ${'serviceWorker' in navigator ? 'âœ… Ù†Ø¹Ù…' : 'âŒ Ù„Ø§'}</p>
                <p><strong>Cache API:</strong> ${'caches' in window ? 'âœ… Ù†Ø¹Ù…' : 'âŒ Ù„Ø§'}</p>
                <p><strong>Push API:</strong> ${'PushManager' in window ? 'âœ… Ù†Ø¹Ù…' : 'âŒ Ù„Ø§'}</p>
            `;
        }
        
        // ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ
        window.addEventListener('load', function() {
            showBrowserInfo();
            log('ğŸš€ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±');
            
            // Ø§Ø®ØªØ¨Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠ
            setTimeout(() => {
                testServiceWorker();
            }, 1000);
        });
    </script>
</body>
</html>