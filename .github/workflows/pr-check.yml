name: ✅ Pull Request Check

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'mobile/**'
      - '.github/workflows/**'

permissions:
  contents: read
  pull-requests: write
  checks: write

concurrency:
  group: pr-check-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: '3.24.0'
  JAVA_VERSION: '17'

jobs:
  analyze:
    name: 🔍 تحليل الكود
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ✅ جلب الكود
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🐦 تثبيت Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: 📦 كاش الاعتماديات
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            mobile/.dart_tool
          key: ${{ runner.os }}-flutter-pr-${{ hashFiles('mobile/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-pr-
            ${{ runner.os }}-flutter-

      - name: 📥 تحميل الاعتماديات
        working-directory: mobile
        run: flutter pub get

      - name: 🔍 تحليل الكود
        working-directory: mobile
        run: |
          echo "🔍 تشغيل Flutter analyze..."
          flutter analyze > analyze_output.txt 2>&1 || true
          cat analyze_output.txt
          
          # فحص عدد المشاكل
          ISSUES=$(grep -c "issue found" analyze_output.txt || echo "0")
          echo "ANALYZE_ISSUES=$ISSUES" >> $GITHUB_ENV
          
          if [ "$ISSUES" -gt "0" ]; then
            echo "⚠️ تم العثور على $ISSUES مشكلة في الكود"
            exit 1
          else
            echo "✅ لا توجد مشاكل في الكود"
          fi

      - name: 🎨 فحص التنسيق
        working-directory: mobile
        continue-on-error: true
        run: |
          echo "🎨 فحص تنسيق الكود..."
          dart format --output=none --set-exit-if-changed . || echo "⚠️ بعض الملفات تحتاج تنسيق"

  test:
    name: 🧪 تشغيل الاختبارات
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ✅ جلب الكود
        uses: actions/checkout@v4

      - name: 🐦 تثبيت Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: 📦 كاش الاعتماديات
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            mobile/.dart_tool
          key: ${{ runner.os }}-flutter-test-${{ hashFiles('mobile/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-test-
            ${{ runner.os }}-flutter-

      - name: 📥 تحميل الاعتماديات
        working-directory: mobile
        run: flutter pub get

      - name: 🔨 توليد الكود
        working-directory: mobile
        run: |
          flutter pub run build_runner build --delete-conflicting-outputs || echo "⚠️ لا توجد ملفات للتوليد"

      - name: 🧪 تشغيل الاختبارات
        working-directory: mobile
        continue-on-error: true
        run: |
          echo "🧪 تشغيل الاختبارات..."
          flutter test --coverage || echo "⚠️ فشلت بعض الاختبارات أو لا توجد اختبارات"

  build-check:
    name: 🏗️ فحص البناء
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: ✅ جلب الكود
        uses: actions/checkout@v4

      - name: ☕ تثبيت Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: 🐦 تثبيت Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: 📦 كاش الاعتماديات
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-flutter-build-${{ hashFiles('mobile/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-build-
            ${{ runner.os }}-flutter-

      - name: 📥 تحميل الاعتماديات
        working-directory: mobile
        run: flutter pub get

      - name: 🔨 توليد الكود
        working-directory: mobile
        run: |
          flutter pub run build_runner build --delete-conflicting-outputs || echo "⚠️ لا توجد ملفات للتوليد"

      - name: 🏗️ محاولة البناء
        working-directory: mobile
        run: |
          echo "🏗️ فحص إمكانية البناء..."
          flutter build apk --debug --target-platform android-arm64
          
          if [ -f "build/app/outputs/flutter-apk/app-debug.apk" ]; then
            echo "✅ البناء نجح"
            ls -lh build/app/outputs/flutter-apk/app-debug.apk
          else
            echo "❌ فشل البناء"
            exit 1
          fi

  pr-summary:
    name: 📝 ملخص PR
    runs-on: ubuntu-latest
    needs: [analyze, test, build-check]
    if: always()
    
    steps:
      - name: 📝 إنشاء ملخص
        uses: actions/github-script@v7
        with:
          script: |
            const analyze = '${{ needs.analyze.result }}';
            const test = '${{ needs.test.result }}';
            const build = '${{ needs.build-check.result }}';
            
            let summary = '## 📊 ملخص فحص Pull Request\n\n';
            summary += '| الفحص | النتيجة |\n';
            summary += '|-------|--------|\n';
            
            const getEmoji = (result) => {
              if (result === 'success') return '✅';
              if (result === 'failure') return '❌';
              if (result === 'skipped') return '⏭️';
              return '⚠️';
            };
            
            summary += `| 🔍 تحليل الكود | ${getEmoji(analyze)} ${analyze} |\n`;
            summary += `| 🧪 الاختبارات | ${getEmoji(test)} ${test} |\n`;
            summary += `| 🏗️ البناء | ${getEmoji(build)} ${build} |\n\n`;
            
            const allSuccess = analyze === 'success' && 
                               (test === 'success' || test === 'skipped') && 
                               build === 'success';
            
            if (allSuccess) {
              summary += '### ✅ جميع الفحوصات نجحت!\n\n';
              summary += 'يمكن دمج هذا PR بأمان.\n';
            } else {
              summary += '### ⚠️ بعض الفحوصات فشلت\n\n';
              summary += 'يرجى مراجعة الأخطاء وإصلاحها قبل الدمج.\n';
            }
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
