name: ğŸ” PR Quality Check

on:
  pull_request:
    branches: [ main, master, capy/apk-ee3d67eb ]
    paths: 
      - 'mobile/**'
      - '.github/workflows/**'

env:
  FLUTTER_VERSION: '3.22.0'

jobs:
  # ÙØ­Øµ Ø³Ø±ÙŠØ¹ Ù„Ù„ÙƒÙˆØ¯
  quick-check:
    name: âš¡ Quick Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout PR
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø¹ Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
        
    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        
    - name: ğŸ“¦ Get dependencies  
      working-directory: ./mobile
      run: flutter pub get
      
    - name: ğŸ” Analyze code
      working-directory: ./mobile
      run: |
        echo "ğŸ” ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯..."
        flutter analyze --fatal-infos > analysis_report.txt 2>&1 || true
        
        if [[ -s analysis_report.txt ]]; then
          echo "âš ï¸ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø´Ø§ÙƒÙ„ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„:"
          cat analysis_report.txt
          echo "analyze_status=warning" >> $GITHUB_OUTPUT
        else
          echo "âœ… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù†Ø¸ÙŠÙ - Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§ÙƒÙ„!"
          echo "analyze_status=success" >> $GITHUB_OUTPUT
        fi
      id: analyze
      
    - name: ğŸ“Š Count changes
      run: |
        echo "ğŸ“ˆ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª:"
        
        # Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØºÙŠØ±Ø©
        CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }} | wc -l)
        echo "changed_files=${CHANGED_FILES}" >> $GITHUB_OUTPUT
        echo "ğŸ“ Ù…Ù„ÙØ§Øª Ù…ØªØºÙŠØ±Ø©: ${CHANGED_FILES}"
        
        # Ø¹Ø¯Ø¯ Ù…Ù„ÙØ§Øª Dart Ø§Ù„Ù…ØªØºÙŠØ±Ø©
        DART_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }} | grep '\.dart$' | wc -l)
        echo "dart_files=${DART_FILES}" >> $GITHUB_OUTPUT
        echo "ğŸ¯ Ù…Ù„ÙØ§Øª Dart: ${DART_FILES}"
        
        # Ø³Ø·ÙˆØ± Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø¶Ø§ÙØ©/Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©
        ADDITIONS=$(git diff --numstat ${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }} | awk '{sum+=$1} END {print sum}')
        DELETIONS=$(git diff --numstat ${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }} | awk '{sum+=$2} END {print sum}')
        
        echo "additions=${ADDITIONS:-0}" >> $GITHUB_OUTPUT
        echo "deletions=${DELETIONS:-0}" >> $GITHUB_OUTPUT
        echo "â• Ø³Ø·ÙˆØ± Ù…Ø¶Ø§ÙØ©: ${ADDITIONS:-0}"
        echo "â– Ø³Ø·ÙˆØ± Ù…Ø­Ø°ÙˆÙØ©: ${DELETIONS:-0}"
        
      id: changes
      
    - name: ğŸ“ Generate summary
      run: |
        echo "## ğŸ” ØªÙ‚Ø±ÙŠØ± ÙØ­Øµ PR Ø§Ù„Ø³Ø±ÙŠØ¹" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ steps.analyze.outputs.analyze_status }}" == "success" ]]; then
          echo "âœ… **ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯**: Ù†Ø¸ÙŠÙ" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯**: ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "ğŸ“Š **Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª**:" >> $GITHUB_STEP_SUMMARY
        echo "- Ù…Ù„ÙØ§Øª Ù…ØªØºÙŠØ±Ø©: ${{ steps.changes.outputs.changed_files }}" >> $GITHUB_STEP_SUMMARY
        echo "- Ù…Ù„ÙØ§Øª Dart: ${{ steps.changes.outputs.dart_files }}" >> $GITHUB_STEP_SUMMARY
        echo "- Ø³Ø·ÙˆØ± Ù…Ø¶Ø§ÙØ©: ${{ steps.changes.outputs.additions }}" >> $GITHUB_STEP_SUMMARY
        echo "- Ø³Ø·ÙˆØ± Ù…Ø­Ø°ÙˆÙØ©: ${{ steps.changes.outputs.deletions }}" >> $GITHUB_STEP_SUMMARY

  # Ø¨Ù†Ø§Ø¡ ØªØ¬Ø±ÙŠØ¨ÙŠ Ù„Ù„ØªØ£ÙƒØ¯
  build-test:
    name: ğŸ”¨ Build Test
    runs-on: ubuntu-latest
    needs: quick-check
    
    steps:
    - name: ğŸ“¥ Checkout PR
      uses: actions/checkout@v4
      
    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        
    - name: ğŸ“¦ Get dependencies
      working-directory: ./mobile
      run: |
        flutter clean
        flutter pub get
        
    - name: âš™ï¸ Code generation
      working-directory: ./mobile
      run: |
        flutter packages pub run build_runner build --delete-conflicting-outputs
        
    - name: ğŸ”¨ Test build
      working-directory: ./mobile
      run: |
        echo "ğŸ”¨ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¨Ù†Ø§Ø¡..."
        flutter build apk --debug --target-platform android-arm64 > build_log.txt 2>&1
        
        if [[ $? -eq 0 ]]; then
          echo "âœ… Ø§Ù„Ø¨Ù†Ø§Ø¡ Ù†Ø¬Ø­!"
          echo "build_status=success" >> $GITHUB_OUTPUT
        else
          echo "âŒ Ø§Ù„Ø¨Ù†Ø§Ø¡ ÙØ´Ù„!"
          echo "build_status=failed" >> $GITHUB_OUTPUT
          echo "ğŸ” Ø³Ø¬Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡:"
          cat build_log.txt
        fi
      id: build
      
    - name: ğŸ“Š APK info
      if: steps.build.outputs.build_status == 'success'
      working-directory: ./mobile
      run: |
        if [[ -f "build/app/outputs/flutter-apk/app-debug.apk" ]]; then
          APK_SIZE=$(du -h build/app/outputs/flutter-apk/app-debug.apk | cut -f1)
          echo "ğŸ“¦ Ø­Ø¬Ù… APK Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ: ${APK_SIZE}"
          echo "apk_size=${APK_SIZE}" >> $GITHUB_OUTPUT
        fi
      id: apk_info

  # ØªØ¹Ù„ÙŠÙ‚ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù„Ù‰ PR
  pr-comment:
    name: ğŸ’¬ PR Comment
    runs-on: ubuntu-latest
    needs: [quick-check, build-test]
    if: always() # Ø³ÙŠØ¹Ù…Ù„ Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„Øª Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    
    steps:
    - name: ğŸ’¬ Comment on PR
      uses: actions/github-script@v7
      with:
        script: |
          const quickCheck = '${{ needs.quick-check.result }}';
          const buildTest = '${{ needs.build-test.result }}';
          const analyzeStatus = '${{ needs.quick-check.outputs.analyze_status }}' || 'unknown';
          const buildStatus = '${{ needs.build-test.outputs.build_status }}' || 'unknown';
          
          let statusIcon = 'âš ï¸';
          let statusText = 'ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©';
          
          if (quickCheck === 'success' && buildTest === 'success') {
            statusIcon = 'âœ…';
            statusText = 'Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¯Ù…Ø¬';
          } else if (quickCheck === 'failure' || buildTest === 'failure') {
            statusIcon = 'âŒ';  
            statusText = 'ÙŠØ­ØªØ§Ø¬ Ø¥ØµÙ„Ø§Ø­';
          }
          
          const comment = `## ${statusIcon} ØªÙ‚Ø±ÙŠØ± ÙØ­Øµ PR - ${statusText}
          
          ### ğŸ” ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯:
          ${analyzeStatus === 'success' ? 'âœ… Ù†Ø¸ÙŠÙ - Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§ÙƒÙ„' : 'âš ï¸ ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©'}
          
          ### ğŸ”¨ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¨Ù†Ø§Ø¡:
          ${buildStatus === 'success' ? 'âœ… Ù†Ø¬Ø­ Ø§Ù„Ø¨Ù†Ø§Ø¡' : buildStatus === 'failed' ? 'âŒ ÙØ´Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡' : 'â³ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©'}
          
          ### ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª:
          - **Ù…Ù„ÙØ§Øª Ù…ØªØºÙŠØ±Ø©**: ${{ needs.quick-check.outputs.changed_files || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}
          - **Ù…Ù„ÙØ§Øª Dart**: ${{ needs.quick-check.outputs.dart_files || '0' }}  
          - **Ø³Ø·ÙˆØ± Ù…Ø¶Ø§ÙØ©**: ${{ needs.quick-check.outputs.additions || '0' }}
          - **Ø³Ø·ÙˆØ± Ù…Ø­Ø°ÙˆÙØ©**: ${{ needs.quick-check.outputs.deletions || '0' }}
          
          ${buildStatus === 'success' && '${{ needs.build-test.outputs.apk_size }}' ? 
            `### ğŸ“¦ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª APK:\n- **Ø§Ù„Ø­Ø¬Ù…**: ${{ needs.build-test.outputs.apk_size }}\n` : ''}
          
          ### ğŸ“‹ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:
          ${statusIcon === 'âœ…' ? 
            'ğŸ‰ Ø§Ù„ÙƒÙˆØ¯ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¯Ù…Ø¬! ÙŠÙ…ÙƒÙ† Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ PR.' :
            statusIcon === 'âŒ' ?
            'ğŸ”§ ÙŠØ±Ø¬Ù‰ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø£Ø¹Ù„Ø§Ù‡ Ù‚Ø¨Ù„ Ø§Ù„Ø¯Ù…Ø¬.' :
            'ğŸ‘€ ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªØ­Ø°ÙŠØ±Ø§Øª ÙˆØ§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯.'}
          
          ---
          ğŸ¤– ØªÙ… Ø§Ù„ÙØ­Øµ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨ÙˆØ§Ø³Ø·Ø© GitHub Actions
          ğŸ“… ${new Date().toLocaleString('ar-EG', {timeZone: 'UTC'})} UTC`;
          
          // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØªØ¹Ù„ÙŠÙ‚ Ø³Ø§Ø¨Ù‚ ÙˆØªØ­Ø¯ÙŠØ«Ù‡
          const comments = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number
          });
          
          const botComment = comments.data.find(comment => 
            comment.user.type === 'Bot' && comment.body.includes('ØªÙ‚Ø±ÙŠØ± ÙØ­Øµ PR')
          );
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: comment
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
          }