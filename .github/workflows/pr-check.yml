name: âœ… Pull Request Check

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'mobile/**'
      - '.github/workflows/**'

permissions:
  contents: read
  pull-requests: write
  checks: write

concurrency:
  group: pr-check-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: '3.24.0'
  JAVA_VERSION: '17'

jobs:
  analyze:
    name: ğŸ” ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: âœ… Ø¬Ù„Ø¨ Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ¦ ØªØ«Ø¨ÙŠØª Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ ÙƒØ§Ø´ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ÙŠØ§Øª
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            mobile/.dart_tool
          key: ${{ runner.os }}-flutter-pr-${{ hashFiles('mobile/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-pr-
            ${{ runner.os }}-flutter-

      - name: ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ÙŠØ§Øª
        working-directory: mobile
        run: flutter pub get

      - name: ğŸ” ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
        working-directory: mobile
        run: |
          echo "ğŸ” ØªØ´ØºÙŠÙ„ Flutter analyze..."
          flutter analyze > analyze_output.txt 2>&1 || true
          cat analyze_output.txt
          
          # ÙØ­Øµ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„
          ISSUES=$(grep -c "issue found" analyze_output.txt || echo "0")
          echo "ANALYZE_ISSUES=$ISSUES" >> $GITHUB_ENV
          
          if [ "$ISSUES" -gt "0" ]; then
            echo "âš ï¸ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ $ISSUES Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„ÙƒÙˆØ¯"
            exit 1
          else
            echo "âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§ÙƒÙ„ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯"
          fi

      - name: ğŸ¨ ÙØ­Øµ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚
        working-directory: mobile
        continue-on-error: true
        run: |
          echo "ğŸ¨ ÙØ­Øµ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙƒÙˆØ¯..."
          dart format --output=none --set-exit-if-changed . || echo "âš ï¸ Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª ØªØ­ØªØ§Ø¬ ØªÙ†Ø³ÙŠÙ‚"

  test:
    name: ğŸ§ª ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: âœ… Ø¬Ù„Ø¨ Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v4

      - name: ğŸ¦ ØªØ«Ø¨ÙŠØª Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ ÙƒØ§Ø´ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ÙŠØ§Øª
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            mobile/.dart_tool
          key: ${{ runner.os }}-flutter-test-${{ hashFiles('mobile/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-test-
            ${{ runner.os }}-flutter-

      - name: ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ÙŠØ§Øª
        working-directory: mobile
        run: flutter pub get

      - name: ğŸ”¨ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯
        working-directory: mobile
        run: |
          flutter pub run build_runner build --delete-conflicting-outputs || echo "âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª Ù„Ù„ØªÙˆÙ„ÙŠØ¯"

      - name: ğŸ§ª ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
        working-directory: mobile
        continue-on-error: true
        run: |
          echo "ğŸ§ª ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª..."
          flutter test --coverage || echo "âš ï¸ ÙØ´Ù„Øª Ø¨Ø¹Ø¶ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø£Ùˆ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª"

  build-check:
    name: ğŸ—ï¸ ÙØ­Øµ Ø§Ù„Ø¨Ù†Ø§Ø¡
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: âœ… Ø¬Ù„Ø¨ Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v4

      - name: â˜• ØªØ«Ø¨ÙŠØª Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: ğŸ¦ ØªØ«Ø¨ÙŠØª Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ ÙƒØ§Ø´ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ÙŠØ§Øª
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-flutter-build-${{ hashFiles('mobile/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-build-
            ${{ runner.os }}-flutter-

      - name: ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ÙŠØ§Øª
        working-directory: mobile
        run: flutter pub get

      - name: ğŸ”¨ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯
        working-directory: mobile
        run: |
          flutter pub run build_runner build --delete-conflicting-outputs || echo "âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª Ù„Ù„ØªÙˆÙ„ÙŠØ¯"

      - name: ğŸ—ï¸ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡
        working-directory: mobile
        run: |
          echo "ğŸ—ï¸ ÙØ­Øµ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„Ø¨Ù†Ø§Ø¡..."
          flutter build apk --debug --target-platform android-arm64
          
          if [ -f "build/app/outputs/flutter-apk/app-debug.apk" ]; then
            echo "âœ… Ø§Ù„Ø¨Ù†Ø§Ø¡ Ù†Ø¬Ø­"
            ls -lh build/app/outputs/flutter-apk/app-debug.apk
          else
            echo "âŒ ÙØ´Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡"
            exit 1
          fi

  pr-summary:
    name: ğŸ“ Ù…Ù„Ø®Øµ PR
    runs-on: ubuntu-latest
    needs: [analyze, test, build-check]
    if: always()
    
    steps:
      - name: ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ø®Øµ
        uses: actions/github-script@v7
        with:
          script: |
            const analyze = '${{ needs.analyze.result }}';
            const test = '${{ needs.test.result }}';
            const build = '${{ needs.build-check.result }}';
            
            let summary = '## ğŸ“Š Ù…Ù„Ø®Øµ ÙØ­Øµ Pull Request\n\n';
            summary += '| Ø§Ù„ÙØ­Øµ | Ø§Ù„Ù†ØªÙŠØ¬Ø© |\n';
            summary += '|-------|--------|\n';
            
            const getEmoji = (result) => {
              if (result === 'success') return 'âœ…';
              if (result === 'failure') return 'âŒ';
              if (result === 'skipped') return 'â­ï¸';
              return 'âš ï¸';
            };
            
            summary += `| ğŸ” ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ | ${getEmoji(analyze)} ${analyze} |\n`;
            summary += `| ğŸ§ª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª | ${getEmoji(test)} ${test} |\n`;
            summary += `| ğŸ—ï¸ Ø§Ù„Ø¨Ù†Ø§Ø¡ | ${getEmoji(build)} ${build} |\n\n`;
            
            const allSuccess = analyze === 'success' && 
                               (test === 'success' || test === 'skipped') && 
                               build === 'success';
            
            if (allSuccess) {
              summary += '### âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ­ÙˆØµØ§Øª Ù†Ø¬Ø­Øª!\n\n';
              summary += 'ÙŠÙ…ÙƒÙ† Ø¯Ù…Ø¬ Ù‡Ø°Ø§ PR Ø¨Ø£Ù…Ø§Ù†.\n';
            } else {
              summary += '### âš ï¸ Ø¨Ø¹Ø¶ Ø§Ù„ÙØ­ÙˆØµØ§Øª ÙØ´Ù„Øª\n\n';
              summary += 'ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙˆØ¥ØµÙ„Ø§Ø­Ù‡Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø¯Ù…Ø¬.\n';
            }
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
