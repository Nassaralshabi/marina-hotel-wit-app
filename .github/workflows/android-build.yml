 

on:
  # Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø¯ÙØ¹ Ø¹Ù„Ù‰ Ø§Ù„ÙØ±ÙˆØ¹ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø£Ùˆ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'bugfix/**'
  pull_request:
    branches:
      - main
      - develop
  # ØªØ´ØºÙŠÙ„ ÙŠØ¯ÙˆÙŠ
  workflow_dispatch:

jobs:
  build-android:
    name: Build Android Debug APK
    runs-on: ubuntu-latest

    steps:
      # 1. Ø³Ø­Ø¨ Ø§Ù„ÙƒÙˆØ¯
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Ø¥Ø¹Ø¯Ø§Ø¯ Java 17
      - name: Setup Java 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. Ø¥Ø¹Ø¯Ø§Ø¯ Android SDK
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 33
          target: default
          arch: x86_64

      # 4. Ù‚Ø¨ÙˆÙ„ ØªØ±Ø§Ø®ÙŠØµ SDK
      - name: Accept Android SDK Licenses
        run: yes | sdkmanager --licenses

      # 5. ØªØ«Ø¨ÙŠØª Ø£Ø¯ÙˆØ§Øª SDK
      - name: Install SDK Tools
        run: |
          sdkmanager "platform-tools" "platforms;android-33" "build-tools;33.0.0"
          sdkmanager "ndk;21.4.7075529" "cmake;3.18.1"

      # 6. Ø¥Ø¹Ø¯Ø§Ø¯ ÙƒØ§Ø´ Gradle
      - name: Setup Gradle Cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            mobile/.gradle/caches
            mobile/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('mobile/android/build.gradle', 'mobile/android/gradle.properties', 'mobile/android/app/build.gradle') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 7. ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… build_runner
      - name: Generate code with build_runner
        run: |
          cd mobile
          flutter pub get
          flutter pub run build_runner build --delete-conflicting-outputs

      # 8. ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡
      - name: Flutter Clean
        run: |
          cd mobile
          flutter clean

      # 9. Ø¨Ù†Ø§Ø¡ Ù…Ù„Ù APK Ù„Ù„Ù…Ø·ÙˆØ±ÙŠÙ†
      - name: Build Debug APK
        id: build_apk
        continue-on-error: true
        run: |
          cd mobile
          flutter build apk --debug --build-name=debug-1 --build-number=1

      # 10. Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø¥Ø°Ø§ ÙØ´Ù„ Ø£ÙˆÙ„ Ù…Ø±Ø©
      - name: Build Debug APK (Retry)
        if: steps.build_apk.outcome == 'failure'
        run: |
          cd mobile
          flutter clean
          flutter pub get
          flutter pub run build_runner build --delete-conflicting-outputs
          flutter build apk --debug --build-name=debug-1 --build-number=1

      # 11. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¨Ù†Ø§Ø¡
      - name: Verify Build Success
        run: |
          cd mobile
          if ls build/app/outputs/flutter-apk/*.apk 1> /dev/null 2>&1; then
            echo "âœ… APK build successful"
            ls -la build/app/outputs/flutter-apk/
          else
            echo "âŒ APK build failed - no APK files found"
            ls -la build/app/outputs/ || true
            exit 1
          fi

      # 12. Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ù€ APK ÙƒÙ€ artifact
      - name: Upload APK as artifact
        if: success()
        uses: actions/upload-artifact@v3
        with:
          name: android-debug
          path: mobile/build/app/outputs/flutter-apk/*.apk
          retention-days: 30

      # 13. Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡
      - name: Display Build Information
        run: |
          echo "ğŸ—ï¸ Build completed successfully!"
          echo "ğŸ“± APK Location: mobile/build/app/outputs/flutter-apk/"
          echo "ğŸ“¦ Artifact Name: android-debug"
          echo "ğŸ”„ Retention: 30 days"
          cd mobile
          for apk in build/app/outputs/flutter-apk/*.apk; do
            if [ -f "$apk" ]; then
              echo "ğŸ“‹ APK Details:"
              echo "   File: $(basename "$apk")"
              echo "   Size: $(du -h "$apk" | cut -f1)"
              echo "   Path: $apk"
            fi
          done
