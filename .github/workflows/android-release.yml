name: ðŸš€ Android Release Build

"on":
  push:
    branches:
      - main
      - 'release/**'
      - 'capy/**'
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      base_api_url:
        description: 'BASE_API_URL Ù„Ù„Ø¨Ù†Ø§Ø¡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)'
        required: false
        default: ''
      create_release:
        description: 'Ø¥Ù†Ø´Ø§Ø¡ GitHub Release'
        type: boolean
        default: false

permissions:
  contents: write
  actions: read

env:
  FLUTTER_VERSION: '3.24.0'
  JAVA_VERSION: '17'

jobs:
  build-release:
    name: ðŸ—ï¸ Ø¨Ù†Ø§Ø¡ Release APK + AAB
    runs-on: ubuntu-latest
    timeout-minutes: 35
    
    defaults:
      run:
        working-directory: mobile
    
    steps:
      - name: âœ… Ø¬Ù„Ø¨ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ØµØ¯Ø±ÙŠ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• ØªØ«Ø¨ÙŠØª Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: ðŸ¦ ØªØ«Ø¨ÙŠØª Flutter ${{ env.FLUTTER_VERSION }}
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ðŸ“¦ ÙƒØ§Ø´ Ø§Ø¹ØªÙ…Ø§Ø¯ÙŠØ§Øª Flutter
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
            build
          key: ${{ runner.os }}-flutter-release-${{ hashFiles('mobile/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-release-
            ${{ runner.os }}-flutter-

      - name: ðŸ“¦ ÙƒØ§Ø´ Ø§Ø¹ØªÙ…Ø§Ø¯ÙŠØ§Øª Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            android/.gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('mobile/android/gradle/wrapper/gradle-wrapper.properties', 'mobile/android/build.gradle', 'mobile/android/app/build.gradle') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ðŸ” ÙØ­Øµ Flutter
        run: |
          flutter --version
          flutter doctor -v

      - name: ðŸ“‹ Ø­Ø³Ø§Ø¨ Ø±Ù‚Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø±
        id: version
        run: |
          VERSION_NAME=$(grep '^version:' pubspec.yaml | awk '{print $2}' | cut -d'+' -f1)
          BUILD_NUMBER=${{ github.run_number }}
          DATE_UTC=$(date -u +'%Y%m%d')
          
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "date=$DATE_UTC" >> $GITHUB_OUTPUT
          
          echo "ðŸ“¦ Ø§Ù„Ø¥ØµØ¯Ø§Ø±: v$VERSION_NAME"
          echo "ðŸ”¢ Ø±Ù‚Ù… Ø§Ù„Ø¨Ù†Ø§Ø¡: $BUILD_NUMBER"

      - name: ðŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ÙŠØ§Øª
        run: |
          echo "ðŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ø¹ØªÙ…Ø§Ø¯ÙŠØ§Øª Flutter..."
          flutter pub get
          echo "âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ÙŠØ§Øª Ø¨Ù†Ø¬Ø§Ø­"

      - name: ðŸ”¨ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯
        run: |
          echo "ðŸ”¨ ØªØ´ØºÙŠÙ„ build_runner..."
          flutter pub run build_runner build --delete-conflicting-outputs || echo "âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„ÙØ§Øª Ù„Ù„ØªÙˆÙ„ÙŠØ¯"

      - name: ðŸ” Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ (Ø¥Ù† ÙˆØ¬Ø¯)
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          echo "ðŸ” Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ÙØªØ§Ø­ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹..."
          
          if [ -n "$KEYSTORE_BASE64" ] && [ -n "$KEYSTORE_PASSWORD" ]; then
            echo "$KEYSTORE_BASE64" | base64 -d > android/app/upload-keystore.jks
            
            cat > android/key.properties << EOF
          storeFile=upload-keystore.jks
          storePassword=$KEYSTORE_PASSWORD
          keyAlias=$KEY_ALIAS
          keyPassword=$KEY_PASSWORD
          EOF
            echo "âœ… ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹"
          else
            echo "âš ï¸ Ø¨Ø¹Ø¶ Ø£Ø³Ø±Ø§Ø± Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ù…ÙÙ‚ÙˆØ¯Ø© - Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙˆÙ‚ÙŠØ¹ Debug"
          fi

      - name: ðŸ“± Ø¨Ù†Ø§Ø¡ Release APK (ARM64)
        env:
          BASE_API_URL: ${{ github.event.inputs.base_api_url || secrets.BASE_API_URL || 'http://hotelmarina.com/MARINA_HOTEL_PORTABLE/api/v1' }}
        run: |
          echo "ðŸ“± Ø¨Ù†Ø§Ø¡ Release APK (ARM64)..."
          echo "ðŸŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… BASE_API_URL: $BASE_API_URL"
          
          flutter build apk --release \
            --dart-define=BASE_API_URL=$BASE_API_URL \
            --build-name=${{ steps.version.outputs.version_name }} \
            --build-number=${{ steps.version.outputs.build_number }} \
            --target-platform android-arm64 \
            --analyze-size
          
          echo "âœ… ØªÙ… Ø¨Ù†Ø§Ø¡ Release APK Ø¨Ù†Ø¬Ø§Ø­"

      - name: ðŸ“± Ø¨Ù†Ø§Ø¡ Release APK (Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠØ§Øª - Split)
        env:
          BASE_API_URL: ${{ github.event.inputs.base_api_url || secrets.BASE_API_URL || 'http://hotelmarina.com/MARINA_HOTEL_PORTABLE/api/v1' }}
        run: |
          echo "ðŸ“± Ø¨Ù†Ø§Ø¡ Release APK Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠØ§Øª..."
          
          flutter build apk --release \
            --dart-define=BASE_API_URL=$BASE_API_URL \
            --build-name=${{ steps.version.outputs.version_name }} \
            --build-number=${{ steps.version.outputs.build_number }} \
            --target-platform android-arm,android-arm64,android-x64 \
            --split-per-abi
          
          echo "âœ… ØªÙ… Ø¨Ù†Ø§Ø¡ APK Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠØ§Øª"

      - name: ðŸ“¦ Ø¨Ù†Ø§Ø¡ AAB (Ù„Ù„Ù€ Play Store)
        env:
          BASE_API_URL: ${{ github.event.inputs.base_api_url || secrets.BASE_API_URL || 'http://hotelmarina.com/MARINA_HOTEL_PORTABLE/api/v1' }}
        run: |
          echo "ðŸ“¦ Ø¨Ù†Ø§Ø¡ Android App Bundle (AAB)..."
          
          flutter build appbundle --release \
            --dart-define=BASE_API_URL=$BASE_API_URL \
            --build-name=${{ steps.version.outputs.version_name }} \
            --build-number=${{ steps.version.outputs.build_number }} \
            --analyze-size
          
          echo "âœ… ØªÙ… Ø¨Ù†Ø§Ø¡ AAB Ø¨Ù†Ø¬Ø§Ø­"

      - name: ðŸ“‚ ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
        run: |
          echo "ðŸ“‚ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¥ØµØ¯Ø§Ø±Ø§Øª..."
          mkdir -p ../releases/apk
          
          # Ù†Ø³Ø® universal APK
          if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
            cp "build/app/outputs/flutter-apk/app-release.apk" \
               "../releases/apk/marina-hotel-v${{ steps.version.outputs.version_name }}-universal.apk"
            echo "âœ… Ù†Ø³Ø® Universal APK"
          fi
          
          # Ù†Ø³Ø® Split APKs
          for f in build/app/outputs/flutter-apk/*-release.apk; do
            if [ -f "$f" ]; then
              base=$(basename "$f")
              abi=""
              case "$base" in
                *arm64-v8a*) abi="arm64" ;;
                *armeabi-v7a*) abi="armv7" ;;
                *x86_64*) abi="x86_64" ;;
              esac
              if [ -n "$abi" ]; then
                cp "$f" "../releases/apk/marina-hotel-v${{ steps.version.outputs.version_name }}-${abi}.apk"
                echo "âœ… Ù†Ø³Ø® $abi APK"
              fi
            fi
          done
          
          # Ù†Ø³Ø® AAB
          if [ -f "build/app/outputs/bundle/release/app-release.aab" ]; then
            cp "build/app/outputs/bundle/release/app-release.aab" \
               "../releases/apk/marina-hotel-v${{ steps.version.outputs.version_name }}.aab"
            echo "âœ… Ù†Ø³Ø® AAB"
          fi
          
          echo "ðŸ“‹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ù†Ø³ÙˆØ®Ø©:"
          ls -lh ../releases/apk/

      - name: ðŸ” ÙØ­Øµ ØµØ­Ø© APK
        run: |
          echo "ðŸ” ÙØ­Øµ ØµØ­Ø© Ù…Ù„ÙØ§Øª APK..."
          cd ../releases/apk
          
          for f in *.apk; do
            if [ -f "$f" ]; then
              echo "ðŸ” ÙØ­Øµ: $f"
              
              # ÙØ­Øµ Ø£Ù† Ø§Ù„Ù…Ù„Ù zip ØµØ­ÙŠØ­
              if ! unzip -t "$f" >/dev/null 2>&1; then
                echo "âŒ Ø®Ø·Ø£: Ø§Ù„Ù…Ù„Ù ØªØ§Ù„Ù - $f"
                exit 1
              fi
              
              # ÙØ­Øµ ÙˆØ¬ÙˆØ¯ AndroidManifest.xml
              if ! unzip -l "$f" | grep -q AndroidManifest.xml; then
                echo "âŒ Ø®Ø·Ø£: AndroidManifest.xml Ù…ÙÙ‚ÙˆØ¯ ÙÙŠ $f"
                exit 1
              fi
              
              echo "âœ… Ø§Ù„Ù…Ù„Ù Ø³Ù„ÙŠÙ…: $f"
            fi
          done
          
          echo "âœ… Ø¬Ù…ÙŠØ¹ Ù…Ù„ÙØ§Øª APK Ø³Ù„ÙŠÙ…Ø©"

      - name: ðŸ“Š ØªÙˆÙ„ÙŠØ¯ Checksums ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØµÙÙŠØ©
        id: checksums
        run: |
          cd ../releases/apk
          
          echo "ðŸ“Š ØªÙˆÙ„ÙŠØ¯ Checksums..."
          echo "date_utc,version,build_number,file,size_bytes,sha256" > metadata.csv
          NOW=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          
          for f in *.apk *.aab; do
            if [ -f "$f" ]; then
              size=$(stat -c%s "$f" 2>/dev/null || stat -f%z "$f")
              sha=$(sha256sum "$f" 2>/dev/null | awk '{print $1}' || shasum -a 256 "$f" | awk '{print $1}')
              
              echo "$NOW,${{ steps.version.outputs.version_name }},${{ steps.version.outputs.build_number }},$f,$size,$sha" >> metadata.csv
              
              # Ø­Ø³Ø§Ø¨ Ø­Ø¬Ù… Ù‚Ø§Ø¨Ù„ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø©
              size_human=$(du -h "$f" | cut -f1)
              echo "ðŸ“¦ $f - $size_human - SHA256: ${sha:0:8}..."
            fi
          done
          
          echo "âœ… ØªÙ… ØªÙˆÙ„ÙŠØ¯ Checksums"

      - name: â¬†ï¸ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª ÙƒÙ€ Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: marina-hotel-release-v${{ steps.version.outputs.version_name }}-build${{ steps.version.outputs.build_number }}
          path: |
            releases/apk/*.apk
            releases/apk/*.aab
            releases/apk/metadata.csv
          retention-days: 90

      - name: ðŸŽ‰ Ø¥Ù†Ø´Ø§Ø¡ GitHub Release (Ù„Ù„Ù€ Tags)
        if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.create_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name || format('v{0}-build{1}', steps.version.outputs.version_name, steps.version.outputs.build_number) }}
          name: Marina Hotel v${{ steps.version.outputs.version_name }}
          body: |
            # ðŸ¨ Marina Hotel Mobile v${{ steps.version.outputs.version_name }}
            
            ## ðŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡
            - **Ø±Ù‚Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø±:** v${{ steps.version.outputs.version_name }}
            - **Ø±Ù‚Ù… Ø§Ù„Ø¨Ù†Ø§Ø¡:** ${{ steps.version.outputs.build_number }}
            - **Ø§Ù„ØªØ§Ø±ÙŠØ®:** ${{ steps.version.outputs.date }}
            - **Commit:** ${{ github.sha }}
            
            ## âœ¨ Ø§Ù„Ù…ÙŠØ²Ø§Øª
            - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© ÙÙ†Ø¯Ù‚ÙŠØ© Ø´Ø§Ù…Ù„ (8 ÙˆØ­Ø¯Ø§Øª)
            - ÙˆØ§Ø¬Ù‡Ø© Ø¹Ø±Ø¨ÙŠØ© RTL
            - Ù…Ø¹Ù…Ø§Ø±ÙŠØ© Offline-First
            - Ù†Ø¸Ø§Ù… Ø¯ÙØ¹ Ù…ØªÙ‚Ø¯Ù… (5 Ø·Ø±Ù‚ Ø¯ÙØ¹)
            - Ø¥ÙŠØµØ§Ù„Ø§Øª ÙˆØªÙ‚Ø§Ø±ÙŠØ± PDF
            - Ù…Ø²Ø§Ù…Ù†Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø°ÙƒÙŠØ©
            
            ## ðŸ“± Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
            - **Universal APK**: Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ØªÙŠ Ù„Ø§ ØªØ¯Ø¹Ù… Split APK
            - **ARM64 APK**: Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø­Ø¯ÙŠØ«Ø© (Ù…ÙˆØµÙ‰ Ø¨Ù‡) 
            - **ARM v7 APK**: Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            - **x86_64 APK**: Ù„Ù„Ù…Ø­Ø§ÙƒÙŠØ§Øª ÙˆØ§Ù„Ø£Ø¬Ù‡Ø²Ø© x86
            - **AAB**: Ù„Ø±ÙØ¹Ù‡ Ø¹Ù„Ù‰ Google Play Store
            
            ## ðŸ“¥ Ø§Ù„ØªØ«Ø¨ÙŠØª
            1. Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù APK Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù„Ø¬Ù‡Ø§Ø²Ùƒ
            2. ÙØ¹Ù‘Ù„ "Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªØ«Ø¨ÙŠØª Ù…Ù† Ù…ØµØ§Ø¯Ø± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©" ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯
            3. Ù‚Ù… Ø¨ØªØ«Ø¨ÙŠØª Ù…Ù„Ù APK
            
            ## ðŸ”§ Ø§Ù„ØªÙ‚Ù†ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©
            - Flutter ${{ env.FLUTTER_VERSION }}
            - Dart SDK
            - Drift (SQLite)
            - Riverpod State Management
            
            ---
            
            ØªÙ… Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… GitHub Actions ðŸ¤–
          draft: false
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
          files: |
            releases/apk/*.apk
            releases/apk/*.aab
            releases/apk/metadata.csv

      - name: ðŸ“ Ù…Ù„Ø®Øµ Ø§Ù„Ø¨Ù†Ø§Ø¡
        if: always()
        run: |
          echo "## ðŸš€ Ù…Ù„Ø®Øµ Ø¨Ù†Ø§Ø¡ Release" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ù†Ø§Ø¡" >> $GITHUB_STEP_SUMMARY
          echo "- **Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø§Ø¡:** Release APK + AAB" >> $GITHUB_STEP_SUMMARY
          echo "- **Ø§Ù„Ø¥ØµØ¯Ø§Ø±:** v${{ steps.version.outputs.version_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Ø±Ù‚Ù… Ø§Ù„Ø¨Ù†Ø§Ø¡:** ${{ steps.version.outputs.build_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Ø§Ù„ØªØ§Ø±ÙŠØ®:** ${{ steps.version.outputs.date }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Ø§Ù„ÙØ±Ø¹:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø©" >> $GITHUB_STEP_SUMMARY
          
          cd releases/apk
          for f in *.apk *.aab; do
            if [ -f "$f" ]; then
              size=$(du -h "$f" | cut -f1)
              echo "- âœ… $f ($size)" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Ø§Ù„ØªØ­Ù…ÙŠÙ„" >> $GITHUB_STEP_SUMMARY
          echo "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…ØªØ§Ø­Ø© ÙÙŠ Artifacts Ø£Ø¹Ù„Ø§Ù‡" >> $GITHUB_STEP_SUMMARY
