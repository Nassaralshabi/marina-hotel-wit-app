name: 🚀 Release Marina Hotel APK

on:
  push:
    tags:
      - 'v*.*.*'  # يُشغل عند إنشاء tag مثل v1.0.0
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'اسم Tag للإصدار (مثل v1.0.0)'
        required: true
        type: string
      release_notes:
        description: 'ملاحظات الإصدار'
        required: false
        type: string
        default: 'تحسينات وإصلاحات متنوعة'

env:
  FLUTTER_VERSION: '3.22.0'

jobs:
  create-release:
    name: 🎉 Create Production Release
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout repository
      uses: actions/checkout@v4
      
    - name: ☕ Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: 🐦 Setup Flutter SDK
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        
    - name: 📁 Navigate and prepare
      working-directory: ./mobile
      run: |
        flutter clean
        flutter pub get
        flutter packages pub run build_runner build --delete-conflicting-outputs
        
    # بناء APK محسّن للإنتاج
    - name: 🏭 Build Production APK
      working-directory: ./mobile
      run: |
        # بناء للمعماريات المختلفة
        flutter build apk --release --split-per-abi
        
        # بناء APK موحد
        flutter build apk --release
        
    - name: 📱 Build App Bundle (AAB)
      working-directory: ./mobile  
      run: |
        flutter build appbundle --release
        
    - name: 📋 Generate release info
      working-directory: ./mobile
      run: |
        # الحصول على معلومات التطبيق
        APP_VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //')
        TAG_NAME=${{ github.event.inputs.tag_name || github.ref_name }}
        
        echo "🏨 Marina Hotel Mobile - إصدار الإنتاج" > release_notes.md
        echo "=====================================" >> release_notes.md
        echo "" >> release_notes.md
        echo "## 📱 معلومات الإصدار" >> release_notes.md
        echo "- **الإصدار**: ${TAG_NAME}" >> release_notes.md
        echo "- **إصدار التطبيق**: ${APP_VERSION}" >> release_notes.md  
        echo "- **تاريخ البناء**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> release_notes.md
        echo "- **Flutter**: ${{ env.FLUTTER_VERSION }}" >> release_notes.md
        echo "" >> release_notes.md
        
        echo "## ✨ المميزات الرئيسية" >> release_notes.md
        echo "" >> release_notes.md
        echo "### 💳 نظام المدفوعات المتقدم:" >> release_notes.md
        echo "- **5 طرق دفع شاملة**: نقدي، بطاقة ائتمانية، تحويل بنكي، شيك، تقسيط" >> release_notes.md
        echo "- **إيصالات فورية**: إيصال PDF احترافي فور كل عملية دفع" >> release_notes.md
        echo "- **فواتير شاملة**: فواتير A4 مفصلة مع جداول الخدمات" >> release_notes.md
        echo "- **سجل متقدم**: بحث وفلترة في جميع المعاملات المالية" >> release_notes.md
        echo "" >> release_notes.md
        
        echo "### 🏠 إدارة الحجوزات:" >> release_notes.md
        echo "- **واجهة محسّنة**: تصميم جديد بنظام البطاقات" >> release_notes.md
        echo "- **عمليات مدمجة**: أزرار سريعة للدفع وتسجيل المغادرة" >> release_notes.md
        echo "- **حالات واضحة**: عرض مرئي لحالة كل حجز" >> release_notes.md
        echo "- **تسجيل مغادرة شامل**: فحص الغرفة والفاتورة النهائية" >> release_notes.md
        echo "" >> release_notes.md
        
        echo "### 📊 الإدارة والتقارير:" >> release_notes.md
        echo "- **إحصائيات يومية**: ملخص شامل لمدفوعات اليوم" >> release_notes.md
        echo "- **لوحة تحكم متقدمة**: إدارة المدفوعات المعلقة" >> release_notes.md
        echo "- **تصدير البيانات**: تصدير PDF وExcel للتقارير" >> release_notes.md
        echo "- **دعم العربية**: واجهة كاملة باللغة العربية مع RTL" >> release_notes.md
        echo "" >> release_notes.md
        
        echo "### 🛡️ الأمان والجودة:" >> release_notes.md
        echo "- **تخزين آمن**: حفظ محلي مع تشفير البيانات الحساسة" >> release_notes.md
        echo "- **نسخ احتياطي**: نظام مزامنة تلقائي مع الخادم" >> release_notes.md
        echo "- **واجهة متجاوبة**: يعمل بسلاسة على جميع أحجام الشاشات" >> release_notes.md
        echo "- **أداء محسّن**: استجابة سريعة وذاكرة مُحسنة" >> release_notes.md
        echo "" >> release_notes.md
        
        if [[ -n "${{ github.event.inputs.release_notes }}" ]]; then
          echo "## 📝 ملاحظات إضافية" >> release_notes.md
          echo "${{ github.event.inputs.release_notes }}" >> release_notes.md
          echo "" >> release_notes.md
        fi
        
        echo "## 📥 التثبيت والاستخدام" >> release_notes.md
        echo "" >> release_notes.md
        echo "### للأجهزة العادية:" >> release_notes.md
        echo "1. حمّل \`marina-hotel-release.apk\`" >> release_notes.md
        echo "2. فعّل \"المصادر غير المعروفة\" في إعدادات الأندرويد" >> release_notes.md
        echo "3. ثبّت التطبيق وابدأ الاستخدام" >> release_notes.md
        echo "" >> release_notes.md
        
        echo "### للنشر على Google Play:" >> release_notes.md
        echo "- استخدم ملف \`marina-hotel-release.aab\` للنشر على المتجر" >> release_notes.md
        echo "" >> release_notes.md
        
        echo "### معماريات مدعومة:" >> release_notes.md
        echo "- ARM64 (معظم الهواتف الحديثة)" >> release_notes.md
        echo "- ARMv7 (الهواتف الأقدم)" >> release_notes.md
        echo "- x86_64 (المحاكيات)" >> release_notes.md
        echo "" >> release_notes.md
        
        # معلومات أحجام الملفات
        echo "## 📦 معلومات الملفات" >> release_notes.md
        echo "" >> release_notes.md
        
        if [[ -f "build/app/outputs/flutter-apk/app-release.apk" ]]; then
          APK_SIZE=$(du -h build/app/outputs/flutter-apk/app-release.apk | cut -f1)
          echo "- **APK موحد**: ${APK_SIZE}" >> release_notes.md
        fi
        
        if [[ -f "build/app/outputs/bundle/release/app-release.aab" ]]; then
          AAB_SIZE=$(du -h build/app/outputs/bundle/release/app-release.aab | cut -f1)
          echo "- **App Bundle**: ${AAB_SIZE}" >> release_notes.md
        fi
        
        echo "" >> release_notes.md
        echo "---" >> release_notes.md
        echo "" >> release_notes.md
        echo "🤖 **تم البناء تلقائياً بواسطة GitHub Actions**" >> release_notes.md
        echo "🏨 **Marina Hotel Development Team**" >> release_notes.md
        echo "📧 **للدعم التقني**: [إنشاء قضية جديدة](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/issues)" >> release_notes.md
        
        echo "Generated release notes:"
        cat release_notes.md
        
    - name: 📁 Prepare release files
      working-directory: ./mobile
      run: |
        mkdir -p release_files
        
        # نسخ الملفات بأسماء واضحة
        if [[ -f "build/app/outputs/flutter-apk/app-release.apk" ]]; then
          cp build/app/outputs/flutter-apk/app-release.apk release_files/marina-hotel-release.apk
        fi
        
        if [[ -f "build/app/outputs/bundle/release/app-release.aab" ]]; then
          cp build/app/outputs/bundle/release/app-release.aab release_files/marina-hotel-release.aab
        fi
        
        # نسخ APK مقسم حسب المعمارية
        if [[ -d "build/app/outputs/flutter-apk" ]]; then
          find build/app/outputs/flutter-apk -name "app-*-release.apk" -exec cp {} release_files/ \;
        fi
        
        # إضافة ملفات معلوماتية
        cp release_notes.md release_files/
        
        # إنشاء checksum للتحقق
        cd release_files
        sha256sum * > checksums.txt
        
        ls -la
        
    - name: 🏷️ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event.inputs.tag_name || github.ref_name }}
        name: 🏨 Marina Hotel Mobile ${{ github.event.inputs.tag_name || github.ref_name }}
        body_path: mobile/release_files/release_notes.md
        files: |
          mobile/release_files/marina-hotel-release.apk
          mobile/release_files/marina-hotel-release.aab
          mobile/release_files/app-*-release.apk
          mobile/release_files/checksums.txt
        draft: false
        prerelease: false
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: 📤 Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: marina-hotel-release-${{ github.event.inputs.tag_name || github.ref_name }}
        path: mobile/release_files/
        retention-days: 90 # حفظ أطول للإصدارات
        
    - name: 🎉 Success notification
      run: |
        echo "## 🎉 تم إنشاء الإصدار بنجاح!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "✅ **Tag**: ${{ github.event.inputs.tag_name || github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "✅ **APK**: تم بناؤه للإنتاج" >> $GITHUB_STEP_SUMMARY  
        echo "✅ **AAB**: جاهز للنشر على Google Play" >> $GITHUB_STEP_SUMMARY
        echo "✅ **Release**: تم إنشاؤه على GitHub" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "🏨 **Marina Hotel Mobile جاهز للنشر!**" >> $GITHUB_STEP_SUMMARY