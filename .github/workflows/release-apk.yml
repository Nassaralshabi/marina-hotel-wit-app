name: ðŸš€ Release Marina Hotel APK

on:
  push:
    tags:
      - 'v*.*.*'  # ÙŠÙØ´ØºÙ„ Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ tag Ù…Ø«Ù„ v1.0.0
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Ø§Ø³Ù… Tag Ù„Ù„Ø¥ØµØ¯Ø§Ø± (Ù…Ø«Ù„ v1.0.0)'
        required: true
        type: string
      release_notes:
        description: 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¥ØµØ¯Ø§Ø±'
        required: false
        type: string
        default: 'ØªØ­Ø³ÙŠÙ†Ø§Øª ÙˆØ¥ØµÙ„Ø§Ø­Ø§Øª Ù…ØªÙ†ÙˆØ¹Ø©'

env:
  FLUTTER_VERSION: '3.22.0'

jobs:
  create-release:
    name: ðŸŽ‰ Create Production Release
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: ðŸ¦ Setup Flutter SDK
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        
    - name: ðŸ“ Navigate and prepare
      working-directory: ./mobile
      run: |
        flutter clean
        flutter pub get
        flutter packages pub run build_runner build --delete-conflicting-outputs
        
    # Ø¨Ù†Ø§Ø¡ APK Ù…Ø­Ø³Ù‘Ù† Ù„Ù„Ø¥Ù†ØªØ§Ø¬
    - name: ðŸ­ Build Production APK
      working-directory: ./mobile
      run: |
        # Ø¨Ù†Ø§Ø¡ Ù„Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠØ§Øª Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
        flutter build apk --release --split-per-abi
        
        # Ø¨Ù†Ø§Ø¡ APK Ù…ÙˆØ­Ø¯
        flutter build apk --release
        
    - name: ðŸ“± Build App Bundle (AAB)
      working-directory: ./mobile  
      run: |
        flutter build appbundle --release
        
    - name: ðŸ“‹ Generate release info
      working-directory: ./mobile
      run: |
        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        APP_VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //')
        TAG_NAME=${{ github.event.inputs.tag_name || github.ref_name }}
        
        echo "ðŸ¨ Marina Hotel Mobile - Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø¥Ù†ØªØ§Ø¬" > release_notes.md
        echo "=====================================" >> release_notes.md
        echo "" >> release_notes.md
        echo "## ðŸ“± Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥ØµØ¯Ø§Ø±" >> release_notes.md
        echo "- **Ø§Ù„Ø¥ØµØ¯Ø§Ø±**: ${TAG_NAME}" >> release_notes.md
        echo "- **Ø¥ØµØ¯Ø§Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚**: ${APP_VERSION}" >> release_notes.md  
        echo "- **ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ù†Ø§Ø¡**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> release_notes.md
        echo "- **Flutter**: ${{ env.FLUTTER_VERSION }}" >> release_notes.md
        echo "" >> release_notes.md
        
        echo "## âœ¨ Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" >> release_notes.md
        echo "" >> release_notes.md
        echo "### ðŸ’³ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…:" >> release_notes.md
        echo "- **5 Ø·Ø±Ù‚ Ø¯ÙØ¹ Ø´Ø§Ù…Ù„Ø©**: Ù†Ù‚Ø¯ÙŠØŒ Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†ÙŠØ©ØŒ ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠØŒ Ø´ÙŠÙƒØŒ ØªÙ‚Ø³ÙŠØ·" >> release_notes.md
        echo "- **Ø¥ÙŠØµØ§Ù„Ø§Øª ÙÙˆØ±ÙŠØ©**: Ø¥ÙŠØµØ§Ù„ PDF Ø§Ø­ØªØ±Ø§ÙÙŠ ÙÙˆØ± ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ© Ø¯ÙØ¹" >> release_notes.md
        echo "- **ÙÙˆØ§ØªÙŠØ± Ø´Ø§Ù…Ù„Ø©**: ÙÙˆØ§ØªÙŠØ± A4 Ù…ÙØµÙ„Ø© Ù…Ø¹ Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª" >> release_notes.md
        echo "- **Ø³Ø¬Ù„ Ù…ØªÙ‚Ø¯Ù…**: Ø¨Ø­Ø« ÙˆÙÙ„ØªØ±Ø© ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©" >> release_notes.md
        echo "" >> release_notes.md
        
        echo "### ðŸ  Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª:" >> release_notes.md
        echo "- **ÙˆØ§Ø¬Ù‡Ø© Ù…Ø­Ø³Ù‘Ù†Ø©**: ØªØµÙ…ÙŠÙ… Ø¬Ø¯ÙŠØ¯ Ø¨Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª" >> release_notes.md
        echo "- **Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ø¯Ù…Ø¬Ø©**: Ø£Ø²Ø±Ø§Ø± Ø³Ø±ÙŠØ¹Ø© Ù„Ù„Ø¯ÙØ¹ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©" >> release_notes.md
        echo "- **Ø­Ø§Ù„Ø§Øª ÙˆØ§Ø¶Ø­Ø©**: Ø¹Ø±Ø¶ Ù…Ø±Ø¦ÙŠ Ù„Ø­Ø§Ù„Ø© ÙƒÙ„ Ø­Ø¬Ø²" >> release_notes.md
        echo "- **ØªØ³Ø¬ÙŠÙ„ Ù…ØºØ§Ø¯Ø±Ø© Ø´Ø§Ù…Ù„**: ÙØ­Øµ Ø§Ù„ØºØ±ÙØ© ÙˆØ§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©" >> release_notes.md
        echo "" >> release_notes.md
        
        echo "### ðŸ“Š Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±:" >> release_notes.md
        echo "- **Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙŠÙˆÙ…ÙŠØ©**: Ù…Ù„Ø®Øµ Ø´Ø§Ù…Ù„ Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…" >> release_notes.md
        echo "- **Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ù…ØªÙ‚Ø¯Ù…Ø©**: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©" >> release_notes.md
        echo "- **ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª**: ØªØµØ¯ÙŠØ± PDF ÙˆExcel Ù„Ù„ØªÙ‚Ø§Ø±ÙŠØ±" >> release_notes.md
        echo "- **Ø¯Ø¹Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©**: ÙˆØ§Ø¬Ù‡Ø© ÙƒØ§Ù…Ù„Ø© Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù…Ø¹ RTL" >> release_notes.md
        echo "" >> release_notes.md
        
        echo "### ðŸ›¡ï¸ Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„Ø¬ÙˆØ¯Ø©:" >> release_notes.md
        echo "- **ØªØ®Ø²ÙŠÙ† Ø¢Ù…Ù†**: Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ Ù…Ø¹ ØªØ´ÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø©" >> release_notes.md
        echo "- **Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ**: Ù†Ø¸Ø§Ù… Ù…Ø²Ø§Ù…Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ø¹ Ø§Ù„Ø®Ø§Ø¯Ù…" >> release_notes.md
        echo "- **ÙˆØ§Ø¬Ù‡Ø© Ù…ØªØ¬Ø§ÙˆØ¨Ø©**: ÙŠØ¹Ù…Ù„ Ø¨Ø³Ù„Ø§Ø³Ø© Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø£Ø­Ø¬Ø§Ù… Ø§Ù„Ø´Ø§Ø´Ø§Øª" >> release_notes.md
        echo "- **Ø£Ø¯Ø§Ø¡ Ù…Ø­Ø³Ù‘Ù†**: Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø³Ø±ÙŠØ¹Ø© ÙˆØ°Ø§ÙƒØ±Ø© Ù…ÙØ­Ø³Ù†Ø©" >> release_notes.md
        echo "" >> release_notes.md
        
        if [[ -n "${{ github.event.inputs.release_notes }}" ]]; then
          echo "## ðŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©" >> release_notes.md
          echo "${{ github.event.inputs.release_notes }}" >> release_notes.md
          echo "" >> release_notes.md
        fi
        
        echo "## ðŸ“¥ Ø§Ù„ØªØ«Ø¨ÙŠØª ÙˆØ§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…" >> release_notes.md
        echo "" >> release_notes.md
        echo "### Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©:" >> release_notes.md
        echo "1. Ø­Ù…Ù‘Ù„ \`marina-hotel-release.apk\`" >> release_notes.md
        echo "2. ÙØ¹Ù‘Ù„ \"Ø§Ù„Ù…ØµØ§Ø¯Ø± ØºÙŠØ± Ø§Ù„Ù…Ø¹Ø±ÙˆÙØ©\" ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯" >> release_notes.md
        echo "3. Ø«Ø¨Ù‘Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆØ§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…" >> release_notes.md
        echo "" >> release_notes.md
        
        echo "### Ù„Ù„Ù†Ø´Ø± Ø¹Ù„Ù‰ Google Play:" >> release_notes.md
        echo "- Ø§Ø³ØªØ®Ø¯Ù… Ù…Ù„Ù \`marina-hotel-release.aab\` Ù„Ù„Ù†Ø´Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªØ¬Ø±" >> release_notes.md
        echo "" >> release_notes.md
        
        echo "### Ù…Ø¹Ù…Ø§Ø±ÙŠØ§Øª Ù…Ø¯Ø¹ÙˆÙ…Ø©:" >> release_notes.md
        echo "- ARM64 (Ù…Ø¹Ø¸Ù… Ø§Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„Ø­Ø¯ÙŠØ«Ø©)" >> release_notes.md
        echo "- ARMv7 (Ø§Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„Ø£Ù‚Ø¯Ù…)" >> release_notes.md
        echo "- x86_64 (Ø§Ù„Ù…Ø­Ø§ÙƒÙŠØ§Øª)" >> release_notes.md
        echo "" >> release_notes.md
        
        # Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£Ø­Ø¬Ø§Ù… Ø§Ù„Ù…Ù„ÙØ§Øª
        echo "## ðŸ“¦ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù„ÙØ§Øª" >> release_notes.md
        echo "" >> release_notes.md
        
        if [[ -f "build/app/outputs/flutter-apk/app-release.apk" ]]; then
          APK_SIZE=$(du -h build/app/outputs/flutter-apk/app-release.apk | cut -f1)
          echo "- **APK Ù…ÙˆØ­Ø¯**: ${APK_SIZE}" >> release_notes.md
        fi
        
        if [[ -f "build/app/outputs/bundle/release/app-release.aab" ]]; then
          AAB_SIZE=$(du -h build/app/outputs/bundle/release/app-release.aab | cut -f1)
          echo "- **App Bundle**: ${AAB_SIZE}" >> release_notes.md
        fi
        
        echo "" >> release_notes.md
        echo "---" >> release_notes.md
        echo "" >> release_notes.md
        echo "ðŸ¤– **ØªÙ… Ø§Ù„Ø¨Ù†Ø§Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨ÙˆØ§Ø³Ø·Ø© GitHub Actions**" >> release_notes.md
        echo "ðŸ¨ **Marina Hotel Development Team**" >> release_notes.md
        echo "ðŸ“§ **Ù„Ù„Ø¯Ø¹Ù… Ø§Ù„ØªÙ‚Ù†ÙŠ**: [Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø¶ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/issues)" >> release_notes.md
        
        echo "Generated release notes:"
        cat release_notes.md
        
    - name: ðŸ“ Prepare release files
      working-directory: ./mobile
      run: |
        mkdir -p release_files
        
        # Ù†Ø³Ø® Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨Ø£Ø³Ù…Ø§Ø¡ ÙˆØ§Ø¶Ø­Ø©
        if [[ -f "build/app/outputs/flutter-apk/app-release.apk" ]]; then
          cp build/app/outputs/flutter-apk/app-release.apk release_files/marina-hotel-release.apk
        fi
        
        if [[ -f "build/app/outputs/bundle/release/app-release.aab" ]]; then
          cp build/app/outputs/bundle/release/app-release.aab release_files/marina-hotel-release.aab
        fi
        
        # Ù†Ø³Ø® APK Ù…Ù‚Ø³Ù… Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠØ©
        if [[ -d "build/app/outputs/flutter-apk" ]]; then
          find build/app/outputs/flutter-apk -name "app-*-release.apk" -exec cp {} release_files/ \;
        fi
        
        # Ø¥Ø¶Ø§ÙØ© Ù…Ù„ÙØ§Øª Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙŠØ©
        cp release_notes.md release_files/
        
        # Ø¥Ù†Ø´Ø§Ø¡ checksum Ù„Ù„ØªØ­Ù‚Ù‚
        cd release_files
        sha256sum * > checksums.txt
        
        ls -la
        
    - name: ðŸ·ï¸ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event.inputs.tag_name || github.ref_name }}
        name: ðŸ¨ Marina Hotel Mobile ${{ github.event.inputs.tag_name || github.ref_name }}
        body_path: mobile/release_files/release_notes.md
        files: |
          mobile/release_files/marina-hotel-release.apk
          mobile/release_files/marina-hotel-release.aab
          mobile/release_files/app-*-release.apk
          mobile/release_files/checksums.txt
        draft: false
        prerelease: false
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ðŸ“¤ Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: marina-hotel-release-${{ github.event.inputs.tag_name || github.ref_name }}
        path: mobile/release_files/
        retention-days: 90 # Ø­ÙØ¸ Ø£Ø·ÙˆÙ„ Ù„Ù„Ø¥ØµØ¯Ø§Ø±Ø§Øª
        
    - name: ðŸŽ‰ Success notification
      run: |
        echo "## ðŸŽ‰ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Tag**: ${{ github.event.inputs.tag_name || github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **APK**: ØªÙ… Ø¨Ù†Ø§Ø¤Ù‡ Ù„Ù„Ø¥Ù†ØªØ§Ø¬" >> $GITHUB_STEP_SUMMARY  
        echo "âœ… **AAB**: Ø¬Ø§Ù‡Ø² Ù„Ù„Ù†Ø´Ø± Ø¹Ù„Ù‰ Google Play" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Release**: ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ø¹Ù„Ù‰ GitHub" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ¨ **Marina Hotel Mobile Ø¬Ø§Ù‡Ø² Ù„Ù„Ù†Ø´Ø±!**" >> $GITHUB_STEP_SUMMARY