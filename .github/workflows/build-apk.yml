name: ðŸ¨ Build Marina Hotel APK

on:
  push:
    branches: [ main, master, capy/apk-ee3d67eb, capy/cap-1-aff99d80 ]
  pull_request:
    branches: [ main, master, capy/apk-ee3d67eb ]
  workflow_dispatch: # ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ
    inputs:
      release_name:
        description: 'Ø§Ø³Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)'
        required: false
        default: 'Marina Hotel Mobile'

env:
  FLUTTER_VERSION: '3.22.0'

jobs:
  build-apk:
    name: ðŸ”¨ Build Flutter APK
    runs-on: ubuntu-latest
    
    steps:
    # 1. Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„ÙƒÙˆØ¯
    - name: ðŸ“¥ Checkout repository  
      uses: actions/checkout@v4
      
    # 2. Ø¥Ø¹Ø¯Ø§Ø¯ Java
    - name: â˜• Setup Java JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    # 3. Ø¥Ø¹Ø¯Ø§Ø¯ Flutter
    - name: ðŸ¦ Setup Flutter SDK
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        
    # 4. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Flutter
    - name: ðŸ” Verify Flutter installation
      run: |
        flutter --version
        flutter doctor -v
        
    # 5. Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
    - name: ðŸ“ Navigate to mobile directory
      working-directory: ./mobile
      run: pwd && ls -la
      
    # 6. ØªÙ†Ø¸ÙŠÙ cache
    - name: ðŸ§¹ Clean Flutter cache
      working-directory: ./mobile
      run: flutter clean
      
    # 7. ØªØ«Ø¨ÙŠØª dependencies
    - name: ðŸ“¦ Get Flutter dependencies
      working-directory: ./mobile
      run: flutter pub get
      
    # 8. ØªØ´ØºÙŠÙ„ code generation
    - name: âš™ï¸ Run code generation
      working-directory: ./mobile
      run: |
        flutter packages pub run build_runner build --delete-conflicting-outputs
        
    # 9. ÙØ­Øµ Ø§Ù„ÙƒÙˆØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    - name: ðŸ” Analyze code
      working-directory: ./mobile
      run: flutter analyze --fatal-infos
      continue-on-error: true # Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„
      
    # 10. Ø¨Ù†Ø§Ø¡ APK Debug
    - name: ðŸ”¨ Build APK (Debug)
      working-directory: ./mobile
      run: |
        flutter build apk --debug --target-platform android-arm64
        
    # 11. Ø¨Ù†Ø§Ø¡ APK Release  
    - name: ðŸš€ Build APK (Release)
      working-directory: ./mobile
      run: |
        flutter build apk --release --target-platform android-arm64
        
    # 12. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡
    - name: ðŸ“‹ Generate build info
      working-directory: ./mobile
      run: |
        echo "ðŸ“± Marina Hotel Mobile APK" > build_info.txt
        echo "ðŸ¨ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙ†Ø¯Ù‚ Ù…Ø¹ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©" >> build_info.txt
        echo "" >> build_info.txt
        echo "ðŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ù†Ø§Ø¡: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> build_info.txt
        echo "ðŸŒ² Ø§Ù„ÙØ±Ø¹: ${GITHUB_REF#refs/heads/}" >> build_info.txt
        echo "ðŸ“ Commit: ${GITHUB_SHA:0:8}" >> build_info.txt
        echo "ðŸ‘¤ Ø¨ÙˆØ§Ø³Ø·Ø©: ${GITHUB_ACTOR}" >> build_info.txt
        echo "" >> build_info.txt
        echo "âœ¨ Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:" >> build_info.txt
        echo "â€¢ ðŸ’³ Ù†Ø¸Ø§Ù… Ù…Ø¯ÙÙˆØ¹Ø§Øª Ù…ØªÙ‚Ø¯Ù… (5 Ø·Ø±Ù‚ Ø¯ÙØ¹)" >> build_info.txt
        echo "â€¢ ðŸ“„ Ø¥ÙŠØµØ§Ù„Ø§Øª ÙˆÙÙˆØ§ØªÙŠØ± PDF" >> build_info.txt  
        echo "â€¢ ðŸ  ÙˆØ§Ø¬Ù‡Ø© Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø­Ø³Ù‘Ù†Ø©" >> build_info.txt
        echo "â€¢ ðŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØªÙ‚Ø§Ø±ÙŠØ± Ø´Ø§Ù…Ù„Ø©" >> build_info.txt
        echo "â€¢ ðŸ” Ø¨Ø­Ø« ÙˆÙÙ„ØªØ±Ø© Ù…ØªÙ‚Ø¯Ù…Ø©" >> build_info.txt
        echo "" >> build_info.txt
        
        # Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø­Ø¬Ù… Ø§Ù„Ù…Ù„ÙØ§Øª
        if [ -f "build/app/outputs/flutter-apk/app-debug.apk" ]; then
          DEBUG_SIZE=$(du -h build/app/outputs/flutter-apk/app-debug.apk | cut -f1)
          echo "ðŸ“¦ Ø­Ø¬Ù… APK Debug: $DEBUG_SIZE" >> build_info.txt
        fi
        
        if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
          RELEASE_SIZE=$(du -h build/app/outputs/flutter-apk/app-release.apk | cut -f1)
          echo "ðŸ“¦ Ø­Ø¬Ù… APK Release: $RELEASE_SIZE" >> build_info.txt
        fi
        
        cat build_info.txt
        
    # 13. ØªØ¬Ù‡ÙŠØ² Ù…Ù„ÙØ§Øª Ù„Ù„Ø±ÙØ¹
    - name: ðŸ“ Prepare artifacts
      working-directory: ./mobile
      run: |
        mkdir -p apk_output
        
        # Ù†Ø³Ø® APK files Ù…Ø¹ Ø£Ø³Ù…Ø§Ø¡ ÙˆØ§Ø¶Ø­Ø©
        if [ -f "build/app/outputs/flutter-apk/app-debug.apk" ]; then
          cp build/app/outputs/flutter-apk/app-debug.apk apk_output/marina-hotel-debug-${GITHUB_SHA:0:8}.apk
        fi
        
        if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
          cp build/app/outputs/flutter-apk/app-release.apk apk_output/marina-hotel-release-${GITHUB_SHA:0:8}.apk
          # Ù†Ø³Ø®Ø© Ø¨Ø¯ÙˆÙ† hash Ù„Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ù‡Ù„
          cp build/app/outputs/flutter-apk/app-release.apk apk_output/marina-hotel-latest.apk
        fi
        
        # Ù†Ø³Ø® Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡
        cp build_info.txt apk_output/
        
        ls -la apk_output/
        
    # 14. Ø±ÙØ¹ APK ÙƒÙ€ artifacts
    - name: ðŸ“¤ Upload APK artifacts
      uses: actions/upload-artifact@v4
      with:
        name: marina-hotel-apk-${{ github.sha }}
        path: mobile/apk_output/
        retention-days: 30
        
    # 15. Ø¥Ù†Ø´Ø§Ø¡ release ØªÙ„Ù‚Ø§Ø¦ÙŠ (ÙÙ‚Ø· Ù„Ù„ÙØ±ÙˆØ¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©)
    - name: ðŸ·ï¸ Create Release
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/capy/apk-ee3d67eb')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v1.0.0-${{ github.sha }}
        name: ${{ github.event.inputs.release_name || 'Marina Hotel Mobile' }} - ${{ github.sha }}
        body: |
          ðŸ¨ **Marina Hotel Mobile - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙ†Ø¯Ù‚**
          
          ## âœ¨ Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¥ØµØ¯Ø§Ø±:
          
          ### ðŸ’³ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…:
          - 5 Ø·Ø±Ù‚ Ø¯ÙØ¹: Ù†Ù‚Ø¯ÙŠØŒ Ø¨Ø·Ø§Ù‚Ø©ØŒ ØªØ­ÙˆÙŠÙ„ØŒ Ø´ÙŠÙƒØŒ ØªÙ‚Ø³ÙŠØ·
          - Ø¥ÙŠØµØ§Ù„Ø§Øª ÙˆÙÙˆØ§ØªÙŠØ± PDF Ø§Ø­ØªØ±Ø§ÙÙŠØ© 
          - Ø³Ø¬Ù„ Ù…Ø¯ÙÙˆØ¹Ø§Øª Ù…Ø¹ Ø¨Ø­Ø« ÙˆÙÙ„ØªØ±Ø©
          - Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ù…ØºØ§Ø¯Ø±Ø© Ø´Ø§Ù…Ù„
          
          ### ðŸ  ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª:
          - ØªØµÙ…ÙŠÙ… Ø¬Ø¯ÙŠØ¯ Ø¨Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
          - Ø£Ø²Ø±Ø§Ø± Ù…Ø¯Ù…Ø¬Ø© Ù„Ù„Ø¯ÙØ¹ ÙˆØ§Ù„Ø®Ø±ÙˆØ¬
          - Ø¹Ø±Ø¶ ÙˆØ§Ø¶Ø­ Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª
          
          ### ðŸ“Š Ø¥Ø¯Ø§Ø±Ø© Ù…ØªÙ‚Ø¯Ù…Ø©:
          - Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙŠÙˆÙ…ÙŠØ© Ø´Ø§Ù…Ù„Ø©
          - ØªÙ‚Ø§Ø±ÙŠØ± Ù…Ø§Ù„ÙŠØ© ØªÙØµÙŠÙ„ÙŠØ©
          - Ø¯Ø¹Ù… ÙƒØ§Ù…Ù„ Ù„Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„Ù„ØºØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
          
          ## ðŸ“± Ø§Ù„ØªØ«Ø¨ÙŠØª:
          1. Ø­Ù…Ù‘Ù„ Ù…Ù„Ù `marina-hotel-latest.apk`
          2. ÙØ¹Ù‘Ù„ "Ù…ØµØ§Ø¯Ø± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©" ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯
          3. Ø«Ø¨Ù‘Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆØ§Ø³ØªÙ…ØªØ¹ Ø¨Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
          
          ## ðŸ”§ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡:
          - **Ø§Ù„ØªØ§Ø±ÙŠØ®**: ${{ github.event.head_commit.timestamp }}
          - **Commit**: ${{ github.sha }}
          - **Flutter**: ${{ env.FLUTTER_VERSION }}
          
          ---
          
          ØªÙ… Ø§Ù„Ø¨Ù†Ø§Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨ÙˆØ§Ø³Ø·Ø© GitHub Actions ðŸ¤–
        files: |
          mobile/apk_output/marina-hotel-latest.apk
          mobile/apk_output/marina-hotel-release-*.apk
          mobile/apk_output/build_info.txt
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    # 16. ØªØ¹Ù„ÙŠÙ‚ Ø¹Ù„Ù‰ PR (Ø¥Ø°Ø§ ÙƒØ§Ù† PR)
    - name: ðŸ’¬ Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const comment = `ðŸŽ‰ **APK ØªÙ… Ø¨Ù†Ø§Ø¤Ù‡ Ø¨Ù†Ø¬Ø§Ø­!**
          
          ðŸ“± ØªÙ… Ø¨Ù†Ø§Ø¡ Marina Hotel Mobile APK Ù…Ø¹ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯.
          
          ## ðŸ“¥ Ø§Ù„ØªØ­Ù…ÙŠÙ„:
          ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ù…ÙŠÙ„ APK Ù…Ù† [ØµÙØ­Ø© Actions](${context.payload.repository.html_url}/actions/runs/${context.runId})
          
          ## âœ… ØªÙ… Ø§Ø®ØªØ¨Ø§Ø±Ù‡:
          - âœ… Flutter analysis Ù…ÙƒØªÙ…Ù„
          - âœ… Code generation Ù…ÙƒØªÙ…Ù„  
          - âœ… APK Debug & Release ØªÙ… Ø¨Ù†Ø§Ø¤Ù‡Ù…Ø§
          
          ## ðŸ” Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±:
          1. Ø­Ù…Ù‘Ù„ APK Ù…Ù† Artifacts Ø£Ø¹Ù„Ø§Ù‡
          2. Ø«Ø¨Ù‘Øª Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø² Android Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
          3. Ø§Ø®ØªØ¨Ø± Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯
          
          ---
          ðŸ¤– ØªÙ… Ø¨Ù†Ø§Ø¤Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨ÙˆØ§Ø³Ø·Ø© GitHub Actions`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  # job Ø¥Ø¶Ø§ÙÙŠ Ù„ÙØ­Øµ Ø§Ù„Ø¬ÙˆØ¯Ø©
  quality-check:
    name: ðŸ” Quality & Security Check
    runs-on: ubuntu-latest
    needs: build-apk
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        
    - name: ðŸ“¦ Get dependencies
      working-directory: ./mobile
      run: flutter pub get
      
    - name: ðŸ›¡ï¸ Security scan
      working-directory: ./mobile
      run: |
        echo "ðŸ”’ ÙØ­Øµ Ø§Ù„Ø£Ù…Ø§Ù†..."
        # ÙØ­Øµ Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„Ù…ÙƒØªØ¨Ø§Øª
        flutter pub deps --json | jq '.packages[] | select(.kind=="direct") | .name' || true
        
    - name: ðŸ“Š Code metrics
      working-directory: ./mobile  
      run: |
        echo "ðŸ“ˆ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙƒÙˆØ¯..."
        find lib/ -name "*.dart" | wc -l | xargs echo "Ø¹Ø¯Ø¯ Ù…Ù„ÙØ§Øª Dart:"
        find lib/ -name "*.dart" -exec wc -l {} + | tail -1 | xargs echo "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£Ø³Ø·Ø± Ø§Ù„ÙƒÙˆØ¯:"
        
    - name: âœ… Generate summary
      run: |
        echo "## ðŸŽ¯ Ù…Ù„Ø®Øµ Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY  
        echo "âœ… **APK ØªÙ… Ø¨Ù†Ø§Ø¤Ù‡ Ø¨Ù†Ø¬Ø§Ø­**" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **ÙØ­ÙˆØµØ§Øª Ø§Ù„Ø¬ÙˆØ¯Ø© Ù…ÙƒØªÙ…Ù„Ø©**" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ§Ù„Ù†Ø´Ø±**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ¨ **Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ù†Ø´Ø· ÙˆÙ…ÙØ¹Ù‘Ù„!**" >> $GITHUB_STEP_SUMMARY