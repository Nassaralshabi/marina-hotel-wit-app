# خطة جعل تطبيق Flutter يعمل بكفاءة بدون اتصال بالإنترنت

## 1. توحيد بنية البيانات المحلية
- مراجعة جميع الجداول في Drift والتأكد من وجود الحقول والروابط المطلوبة لتغطية كل وظائف التطبيق (حجوزات، مدفوعات، مصروفات، ملاحظات، مستخدمين...).
- إضافة جداول مساندة لحفظ حالة المزامنة (Outbox، SyncState) لكل كيان يتم تحديثه أثناء عدم الاتصال.
- تعريف مفاتيح منطقية (localUuid) تضمن عدم تضارب السجلات عند إرسالها إلى الخادم لاحقًا.

## 2. إدارة المزامنة ثنائية الاتجاه
- توسيع خدمة المزامنة الحالية لتغطية جميع الجداول؛ بحيث تشمل عمليات السحب (pull) والدفع (push) لكل من الحجوزات، المصروفات، المدفوعات، الملاحظات، وسجلات الصندوق.
- بناء نظام أولويات للمزامنة (على سبيل المثال: الحجوزات والمدفوعات أولًا، ثم المصروفات، ثم السجلات الثانوية) لتقليل زمن الانتظار عند توفر الاتصال.
- تسجيل الطوابع الزمنية (lastModified) لكل سجل محلي ومقارنته مع السجل الخادمي لتحديد التعديلات المتعارضة، مع وضع سياسة واضحة للحل (server wins، أو user confirmation عند التعارض).

## 3. دعم وضع عدم الاتصال في واجهات المستخدم
- التأكد من أن الشاشات تعمل على البيانات المحلية فقط عند فقد الاتصال (استخدام Stream/State من Drift مباشرة دون طلبات HTTP).
- إظهار شارات أو رسائل خفيفة توضح للمستخدم أن التطبيق يعمل دون اتصال مع عرض آخر وقت تمت فيه المزامنة.
- التعامل مع عمليات الإدخال (نماذج إضافة/تعديل) بحيث يتم حفظها محليًا فورًا مع إدخال مهمة في outbox تنتظر الاتصال لإرسالها.

## 4. إدارة الوسائط والملفات
- تخزين الصور التي يتم رفعها (مثل صور الغرف) في التخزين المحلي للجهاز (application documents directory)، مع حفظ المسار في قاعدة البيانات.
- إنشاء قائمة انتظار لتحميل هذه الوسائط للخادم عند توفر الاتصال، مع مراقبة حالات الفشل وإعادة المحاولة.

## 5. أدوات مراقبة الاتصال
- استخدام `connectivity_plus` لمراقبة تبدل حالة الشبكة وتحديث واجهة المستخدم وفقًا لذلك.
- تشغيل المزامنة تلقائياً عند الانتقال من وضع عدم الاتصال إلى الاتصال، مع ضمان عدم تعارض العمليات الجارية.

## 6. إدارة الصلاحيات والتحقق من الهوية
- الحفاظ على جلسة المستخدم محليًا (توكن/مفاتيح) بطريقة آمنة (`flutter_secure_storage`).
- تفعيل القدرة على الدخول باستخدام بيانات آخر مستخدم تم التحقق منه (إذا تم تسجيل الخروج أثناء عدم الاتصال، يتم السماح بالدخول بعد التحقق المحلي).
- تسجيل كل التعديلات مع هوية المستخدم المحلي لربطها بالسجلات الخادم بعد المزامنة.

## 7. اختبارات وضمان الجودة
- إعداد سيناريوهات اختبار تحاكي التشغيل دون اتصال (إيقاف الشبكة خلال الاستخدام، إدخال بيانات، ثم إعادة الشبكة والتأكد من تزامنها).
- اختبار تعارض البيانات (تعديل نفس السجل على الجهاز والخادم) وتوثيق سياسة الحل.
- مراقبة أداء التطبيق أثناء العمل على قواعد بيانات كبيرة (تراكم بيانات دون اتصال) وتحسين الاستعلامات والفهارس حسب الحاجة.

## 8. توثيق وتدريب المستخدمين
- إضافة دليل داخل التطبيق أو وثيقة مرفقة تشرح للمستخدمين كيفية التعامل أثناء فقد الاتصال.
- توثيق حالات الأخطاء المتوقعة (مثل تجاوز حدود التخزين المحلي، فشل مزامنة متكرر) وطرق الإصلاح اليدوية.

> باتباع هذه الخطة، يمكن تشغيل التطبيق بشكل متكامل دون اتصال بالإنترنت مع ضمان تزامن البيانات عند عودة الاتصال وإبقاء تجربة المستخدم سلسة ومستقرة.